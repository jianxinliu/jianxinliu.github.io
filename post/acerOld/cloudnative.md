# 云原生技术

参考[阿里云 X CNCF 云原生技术公开课](https://edu.aliyun.com/roadmap/cloudnative?spm=a2c4e.11153940.0.0.4a0765790E8GZa )

## 概述

关键词： 云原生、容器、编排、Docker、Kubernetes、

微信小程序可以作为理解云原生应用的例子。微信提供小程序的发布、更新和运行，云数据库，小程序运行情况监控与观测

应用全部运行在云端以及由此产生的一系列问题。包括以下几个方面。

云原生的技术范畴包括了以下几个方面：

- 第一部分是**云应用定义与开发流程**。这包括应用定义与镜像制作、配置 CI/CD、消息和 Streaming 以及数据库等。
- 第二部分是**云应用的编排与管理流程**。这也是 Kubernetes 比较关注的一部分，包括了应用编排与调度、服务发现治理、远程调用、API 网关以及 Service Mesh。（将云应用比作微服务，比作进程）



第三部分是**监控与可观测性**。这部分所强调的是云上应用如何进行监控、日志收集、Tracing 以及在云上如何实现破坏性测试，也就是混沌工程的概念。


- 第四部分就是**云原生的底层技术**，比如**容器运行时**、**云原生存储技术**、**云原生网络技术**等。
- 第五部分是**云原生工具集**，在前面的这些核心技术点之上，还有很多配套的生态或者周边的工具需要使用，比如**流程自动化与配置管理**、**容器镜像仓库**、**云原生安全技术**以及**云端密码管理**等。
- 最后则是 **Serverless**。Serverless 是一种 PaaS 的特殊形态，它定义了一种更为“极端抽象”的应用编写方式，包含了 FaaS 和 BaaS 这样的概念。而无论是 FaaS 还是 BaaS，其最为典型的特点就是按实际使用计费（Pay as you go），因此 Serverless 计费也是重要的知识和概念。

### 云原生关键技术点

1. 如何构建自包含、可定制的应用镜像；
2. 能不能实现应用快速部署与隔离能力；
3. 应用基础设施创建和销毁的自动化管理；
4. 可复制的管控系统和支撑组件。

## 容器与镜像

**容器**：用操作系统管理进程的方式来理解容器。容器可以说是**云环境下的进程管理器**。**容器就是一个视图隔离、资源可限制、独立文件系统的进程集合**（也就是说，**容易容的是进程**）。所谓“**视图隔离**”就是能够看到部分进程以及具有独立的主机名等；**控制资源使用率**则是可以对于内存大小以及 CPU 使用个数等进行限制。容器就是一个进程集合，它将系统的其他资源隔离开来，具有自己独立的资源视图。 容器具有一个独立的文件系统，因为使用的是系统的资源，所以在独立的文件系统内不需要具备内核相关的代码或者工具，我们**只需要提供容器所需的二进制文件、配置文件以及依赖即可。只要容器运行时所需的文件集合都能够具备，那么这个容器就能够运行起来。** 理解为集装箱。

**镜像**：将这些**容器运行时所需要的所有的文件集合称之为容器镜像**。 可理解为模板，或者 Java 中的类，而容器则为创建出来的实例。

使用 Dockerfile 构建镜像，Dockerfile 可以很好的描述**构建的各个步骤**，每个构建步骤都会对文件系统进行操作，造成变化，称为**changeset**。=当把构建步骤锁产生的变化依次作用到空的文件夹上，就形成了一个完整的镜像。

changeset 的分层以及复用特点带来的优势：

1. 镜像拆分之后可以提高分发效率。因为拆分之后可以并行下载。
2. 因为数据是共享的，需要新数据时只需要增量下载即可。
3. 也因为数据是共享的，可以节省磁盘空间。

使用 Dockerfile 构建Golang 应用的例子：

```dockerfile
# 基于 golang:1.2-alpine 镜像构建（可复制）
FROM golang:1.2-alpine

# 设置下列步骤在哪个目录下进行
WORKDIR /go/src/app

# 将宿主机内的文件复制到镜像内
COPY . .

# RUN 在具体的文件系统内执行相应动作

RUN go get -d -v ./..

RUN go install -v ./..

# 使用镜像时的默认名字
CMD ["app"]
```

有了 Dockerfile 之后，就可以通过 `docker build`命令构建所需应用。这样构建的应用存储在本地，通过 `docker push`将本地镜像推到镜像仓库，这样其他环境就可以下载运行。

### 如何运行容器：

1. 从镜像仓库下载镜像到本地
2. 在本地镜像中选择一个启动
3. `docker run ` 运行这个镜像，得到容器。

**当然也可以通过多次运行得到多个容器，镜像就像模板一样，容器就像依照模板创建的实例一样，因此镜像具有一次构建，到处运行的特点。**

### 容器的生命周期

容器是一组具有隔离特性的进程集合，在使用 docker run 的时候会选择一个镜像来提供独立的文件系统并指定相应的运行程序（initial 进程）这个 initial 进程启动的时候，容器也会随之启动，当 initial 进程退出的时候，容器也会随之退出。因此，可以认为**容器的生命周期和 initial 进程的生命周期是一致的**。当 initial 进程退出的时候，所有的子进程也会随之退出，这样也是为了防止资源的泄漏。 

但是这样的做法也会存在一些问题，首先应用里面的程序往往是有状态的，其可能会产生一些重要的数据，当一个容器退出被删除之后，数据也就会丢失了，这对于应用方而言是不能接受的，所以**需要将容器所产生出来的重要数据持久化下来**。容器能够直接将数据持久化到指定的目录上，这个目录就称之为**数据卷**。

数据卷有一些特点，其中非常明显的就是**数据卷的生命周期是独立于容器的生命周期**的，也就是说容器的创建、运行、停止、删除等操作都和数据卷没有任何关系，因为它是一个特殊的目录，是用于帮助容器进行持久化的。

通常情况下，数据卷管理主要有两种方式：

- 第一种是通过 bind 的方式，直接将宿主机的目录直接挂载到容器内；这种方式比较简单，但是会带来运维成本，因为其依赖于宿主机的目录，需要对于所有的宿主机进行统一管理。
- 第二种是将目录管理交给运行引擎。

## Kubernetes 核心概念

和容器的关系。**Kubernetes 是舵手**的意思，**Container 是容器也是集装箱**。故 Kubernetes 是希望**成为运送集装箱的轮船，管理集装箱**。**Kubernetes 是一个自动化的容器编排平台，负责应用的部署、应用的弹性及应用的管理，这些都是基于容器的**。

### 核心功能

- 服务的发现与负载均衡
- 容器的自动装箱（scheduling ）就是调度，把容器放到集群的某个机器上，k8s 也会做存储的编排，让存储的生命周期和容器的生命周期能有个连接。
- 自动化的容器恢复
- 应用的自动发布和自动回滚，与应用相关的配置密文的管理
- 批量执行 job 类型任务
- 水平伸缩，让集群富有弹性。

### 核心功能详解

1. **调度**：就是指 K8s 将户提交的容器合理的放置在 K8s 管理的集群中的某台机器上。** K8s 在进行调度时，会考量容器的**大小规格，以及其所需的 CPU & Memory**，然后选择适合的机器进行放置。
2. **自动修复**：对应的是 K8s 的节点健康检查的功能，K8s 会监测集群中的所有宿主机，当宿主机本身或软件出现故障时，K8s 会自动发现。然后**自动把在失败节点上运行的容器迁移到健康的节点上**，这就是自动恢复。
3. **水平伸缩**：对应的是 K8s 的业务负载检查能力。K8s 会监测业务上所承担的负载，如果应用本身的 CPU 利用率过高或响应时间过长，它就会对这个业务扩容。

### K8s 的架构

