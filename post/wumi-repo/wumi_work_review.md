# Biz


## ä»£ç ä»“åº“ç»“æ„

console-source  å‰ç«¯

phone-business åç«¯

resource èµ„æºå±‚ï¼ˆrpc è°ƒç”¨è€…ï¼‰

operation-console è¿è¥å¹³å°å‰ç«¯

turbolive-server ç›´æ’­å¿«æœåŠ¡ç«¯

pathlive-rpc ç›´æ’­å¿«æœåŠ¡ç«¯ï¼ˆæ–°ï¼‰


èµ„æºå±‚è°ƒç”¨åº•å±‚ xxRpc å®ç°


## ä½¿ç”¨åˆ°çš„åº“

- go-zero Go å¾®æœåŠ¡
- grpc


## misc

github cicd pipeline 

k8s æ„å»º

docker dockerfile 

make makefile

asynQ https://pkg.go.dev/github.com/hibiken/asynq#section-readme

Wireguard VPN å·¥å…·

socat https://www.hi-linux.com/posts/61543.html   ç”¨äºåœ¨ä¸­è½¬æœºä¸Šè¿æ¥ AB ä¸¤ä¸ªç½‘æ®µï¼Œå°†ä¸­è½¬æœºä¸ŠæŸä¸ªç«¯å£çš„æµé‡è½¬å‘åˆ° B ç½‘æ®µçš„æŸå°æœºå™¨çš„æŸä¸ªç«¯å£ï¼Œè¿™æ · A ç½‘æ®µçš„æœºå™¨å°±å¯ä»¥é€šè¿‡è®¿é—®ä¸­è½¬æœºä¸Šçš„ç«¯å£è®¿é—®åˆ° B ç½‘æ®µçš„æœºå™¨ç«¯å£ã€‚



## ğŸŸ©é¡¹ç›®åˆ—è¡¨

-   [ ] phone-businessï¼š äº‘æ‰‹æœºä¸šåŠ¡
-   [ ] turbolive-serverï¼š ç›´æ’­åŠ é€Ÿåº•å±‚ HTTP æœåŠ¡
-   [ ] resourceï¼šèµ„æºå±‚ api & rpc æœåŠ¡
-   [x] usercenterï¼š ç”¨æˆ·ä¸­å¿ƒ RPC & HTTP æœåŠ¡
-   [ ] billing-rpcï¼š è´¦å• RPC æœåŠ¡
-   [ ] pathlive-rpcï¼šç›´æ’­å¿«ç›¸å…³ RPC æœåŠ¡
-   [ ] console-resource: æ§åˆ¶å°å‰ç«¯
-   [ ] operation-api: è¿è¥å¹³å° HTTP æœåŠ¡
-   [ ] operation-console: è¿è¥å¹³å°å‰ç«¯
-   [ ] order: è®¢å•æœåŠ¡
-   [ ] phone-bill-api: æ‰‹æœºè®¢å• HTTP æœåŠ¡
-   [ ] luci-app-turbolive: è½¯è·¯ç”± lua è„šæœ¬
-   [ ] pathlive-router-toolsï¼š è½¯è·¯ç”±å·¥å…·åŒ…
-   [ ] pathlive-luci: è½¯è·¯ç”±ç³»ç»Ÿå®šåˆ¶é¡µé¢ï¼ŒåŠ pathlive çº¿è·¯é›†æˆ
-   [ ] phone-backend-api: äº‘æ‰‹æœºåç«¯æœåŠ¡


## phone-business(æ¯”è¾ƒé€šç”¨çš„æ„å»ºæµç¨‹)

### build

ä½¿ç”¨ docker è¿›è¡Œæ„å»º

1. è¯»å– /deploy/templates ä¸‹çš„é…ç½®æ–‡ä»¶ã€‚åˆ†ä¸º preview & production
2. å°†é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
3. ä½¿ç”¨ `envsubst` å‘½ä»¤å°†é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ä½¿ç”¨ç¯å¢ƒå˜é‡æ›¿æ¢åˆ° `config.tmpl` ä¸­ï¼ˆ`config.tmpl` æ˜¯é…ç½®çš„æ¨¡æ¿ï¼Œåªéœ€è¦å¾€é‡Œé¢å¡«å……å¯¹åº”çš„å‚æ•°å³å¯ï¼‰
4. å°†æ›¿æ¢ç»“æœå†™å…¥åˆ° `phone-api.yaml` ä¸‹ã€‚ï¼ˆæœ€ç»ˆç”Ÿæ•ˆçš„é…ç½®æ–‡ä»¶æ˜¯è¿™ä¸ªï¼‰

#### make æœ¬åœ°æ„å»º

ä½¿ç”¨ make è¿›è¡Œä¸åŒé˜¶æ®µçš„æ„å»ºï¼Œæœ‰ç‚¹ç±»ä¼¼å‰ç«¯é¡¹ç›®ä¸­ package.json ä¸­çš„ scripts å£°æ˜ï¼Œå†™å¥½å¯¹åº”çš„å‘½ä»¤åç›´æ¥ç‚¹å‡»æ‰§è¡Œå³å¯ã€‚

é¡¹ç›®ä¸­çš„ Makefile æ”¯æŒçš„æ“ä½œï¼š

1.   goct ä»£ç ç”Ÿæˆï¼Œ model, api, rpc ç­‰ä»£ç ç”Ÿæˆã€‚æœ‰æ”¹åŠ¨åï¼Œç›´æ¥è¿è¡Œç›¸å…³çš„å‘½ä»¤å³å¯ç”Ÿæˆä»£ç 
2.   é¡¹ç›®æ„å»º
3.   docker builder & push

### deploy

ä½¿ç”¨ github pipeline è¿›è¡Œéƒ¨ç½²

ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼š `.github/workflows`

1. checkout: æ‹‰å–æœ€æ–°ä»£ç 
2. ç”Ÿæˆ image tag(git æäº¤çš„ç›¸å…³ä¿¡æ¯ + æ—¶é—´)
3. æ„å»º docker é•œåƒ & push
4. å°† `/deploy/templates/deploy.tmpl` ä¸­çš„å˜é‡æ›¿æ¢ä¸ºç¯å¢ƒå˜é‡ä¸­çš„å€¼(ä¸»è¦æ˜¯ pipeline ä¸­ xxx-deploy.yaml ä¸­å®šä¹‰çš„å˜é‡)ï¼Œå†™å…¥åˆ° `deploy.yaml` ä¸­ï¼Œä½œä¸º k8s çš„éƒ¨ç½²é…ç½® 
5. éƒ¨ç½²åˆ° k8s

#### api

æä¾›çš„ http æ¥å£ï¼Œé¢å‘å‰ç«¯é¡µé¢ï¼Œå®é™…çš„é€»è¾‘è¿˜æ˜¯é€šè¿‡ rpc è°ƒç”¨ 

#### rpc

phone-business çš„ rpc è°ƒç”¨ç«¯

åœ¨è¿›è¡Œä¸€äº›ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ä¹‹åï¼Œè°ƒç”¨ xxBackend rpc


## tubrolive-server

ä½¿ç”¨ gin ç¼–å†™çš„ web æœåŠ¡ï¼Œåè¿ç§»åˆ° pathlive-rpc ,ä½¿ç”¨ go-zero 

## resource èµ„æºå±‚

go-zero å¼€å‘æ¨¡å¼



### Xphone åº“è¡¨ç»“æ„

1. Model è¡¨ï¼š æ”¯æŒçš„ç±»å‹ï¼ˆé…ç½®è¡¨ï¼‰ï¼š
     1. é‡‘ç‰Œçº¿è·¯ï¼ˆgoldenï¼‰,é‡‘ç‰Œé«˜æ¸…çº¿è·¯ï¼ˆgoldenPlusï¼‰,é“¶ç‰Œçº¿è·¯ï¼ˆSilveryï¼‰ï¼Œç€é‡‘çº¿è·¯ï¼ˆPlatinumï¼‰
     2. UPhone Mini, Phone X, Phone Live
2. Product è¡¨ï¼šäº§å“è¡¨ã€‚è®°å½•æ‰€æœ‰çš„äº§å“ç±»å‹ã€‚å±äºé…ç½®è¡¨ã€‚é€šç”¨ç‰ˆï¼ˆuniversalï¼‰, çŸ©é˜µç‰ˆï¼ˆmatrixï¼‰ï¼Œæ— ç½‘ç‰ˆï¼ˆphone-noipï¼‰â€¦â€¦



### pathlive åº“è¡¨ç»“æ„

1.   lines: ç›´æ’­çº¿è·¯è¡¨ï¼Œè®°å½•çº¿è·¯çš„èµ·å§‹ã€ç»ˆæ­¢åŒºåŸŸï¼ˆä¸Šè½¦ç‚¹: ä»å›½å†…èŠ‚ç‚¹ä¸Šè½¦ï¼Œèµ°ä¸“æœ‰é€šé“åˆ°ä¸‹è½¦ç‚¹ã€ä¸‹è½¦ç‚¹ï¼šæœ€ç»ˆè¯·æ±‚å‘å‡ºåœ°æ˜¯è¯¥ ipï¼‰ï¼Œucloud æä¾›çš„ ip (**bgp_ip**, **vpc_ip**)
     1.   bgp_ip(border gateway protocol): ä¸‹è½¦ç‚¹çš„å¤–ç½‘ IPï¼Œ åˆ†é…å‡ºæ¥çš„ EIPï¼Œå…¬ç½‘ IPï¼Œæœ€ç»ˆåº”ç”¨è¿è¡Œçš„é‚£ä¸ª IPï¼ˆå¦‚ TK èƒ½çœ‹åˆ°ç™»å½•çš„ IPï¼‰
     2.   vpc_ip: ä¸‹è½¦ç‚¹çš„UCloud ç½‘ç»œçš„å†…ç½‘ IPï¼Œæ›´å¿«é€Ÿï¼Œä¸ç®—ä¸‹è½¦ç‚¹çš„å¸¦å®½




### ä»åˆ›å»ºä¸€æ¡çº¿è·¯å¼€å§‹



#### åˆ›å»ºäº‘æ‰‹æœº



1.   å‰ç«¯å‘é€è¯·æ±‚ `/order/create`, æ¥å£å®ç°åœ¨ `phone-bill-api` é¡¹ç›® `ordercreatelogic.go`
     1.   æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼š`userCenterRpc/UserInfo`
     2.   å­è´¦å·ä¸æ”¯æŒåˆ›å»ºè®¢å•
     3.   è´¦å·æœªå®ååˆ¶ä¸æ”¯æŒåˆ›å»ºè®¢å•
     4.   å¦‚æœæ˜¯çŸ©é˜µç‰ˆäº‘æ‰‹æœºï¼Œåˆ™é™åˆ¶ 3 å°èµ·å”®



#### åˆ›å»ºçº¿è·¯

1.   **è®¢å•åˆ›å»º**ï¼šå‰ç«¯å‘é€è¯·æ±‚ `/order/create_path`, æ¥å£å®ç°åœ¨ `phone-bill-api` é¡¹ç›® `createpathorderlogic.go`
     1.   æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼š`userCenterRpc/UserInfo`
     2.   å­è´¦å·ä¸æ”¯æŒåˆ›å»ºè®¢å•
     3.   è´¦å·æœªå®ååˆ¶ä¸æ”¯æŒåˆ›å»ºè®¢å•
     4.   å¦‚æœè´­ä¹°ç±»å‹æ˜¯â€œåˆ°æœˆæœ«â€æˆ–è€…æ˜¯â€œåˆ°ä¸‹æœˆæœ«â€ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰èµ„æ ¼
          1.   æ ¹æ®è¯¥ç”¨æˆ·æ˜¯å¦åœ¨ç™½åå•ä¸­
          2.   å¦‚æœæ˜¯è´­ä¹°åˆ°æœˆæœ«ï¼Œåˆ™æ ¹æ®å½“å‰è·ç¦»æœˆæœ«æ˜¯å¦å¤§äº 7 å¤©
     5.   æ ¹æ®è®¢å•çš„äº§å“ id è·å–äº§å“ä¿¡æ¯ï¼ˆè°ƒç”¨ resourceRpc.GetProductInfoï¼Œå®é™…ä¸Šæ˜¯å» product è¡¨æ ¹æ® product_id æŸ¥è¯¢è®°å½•ï¼‰
     6.   æ ¹æ®äº§å“ id å’ŒåŒºåŸŸ id è·å–ä»·æ ¼ID ã€‚ï¼ˆè°ƒç”¨ resourceRpc.GetResourcePriceï¼Œå®é™…ä¸Šæ˜¯å» resource_price è¡¨æŸ¥è¯¢ï¼‰ï¼ˆprice_id ä¸¾ä¾‹: //resource/products/path-golden/regions/uae-dubaiï¼‰
     7.   æ ¹æ® priceId è·å–å®é™…çš„ä»·æ ¼ï¼ˆè°ƒç”¨ billingRpc.GetPurchasePriceV2ï¼‰(è®¡ä»·è§„åˆ™å•ç‹¬åˆ—ä¸¾)
     8.   æ ¹æ®è®¢å•çš„ regionId è·å– region ä¿¡æ¯ï¼ˆè°ƒç”¨ resourceRpc.GetIpRegionInfoï¼Œå®é™…ä¸Šæ˜¯å» ip_region è¡¨æ ¹æ® regionId æŸ¥è¯¢ä¸€æ¡è®°å½•ï¼‰
     9.   è·å–è®¢å•æŒ‡å®šç»„çš„ç»„ä¿¡æ¯ã€‚ï¼ˆè°ƒç”¨ userCenterRpc.GroupInfo, å®é™…ä¸Šæ˜¯å» group è¡¨æŸ¥è¯¢ï¼‰ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤é‡‡ç”¨â€œé»˜è®¤åˆ†ç»„â€
     10.   order è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•
     11.   å°†å½“å‰è®¢å•ä¿¡æ¯é€šè¿‡å¼‚æ­¥é˜Ÿåˆ—å‘é€ï¼ˆå®é™…ä¸Šä½¿ç”¨çš„æ˜¯ Redisï¼‰
           1.   äº‹ä»¶åï¼šasynq:order:timeoutã€‚ä»»åŠ¡ payload æºå¸¦ä¿¡æ¯ï¼š `<Order type>|<resource type path>|<order id>`
           2.   äº‹ä»¶ Handlerï¼š `order.asnycqServer.HandleOrderPayTimeoutTask`
           3.   å®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ªè¶…æ—¶æœªæ”¯ä»˜å–æ¶ˆè®¢å•çš„ä»»åŠ¡ï¼ˆçŠ¶æ€è®¾ç½®ä¸º timeoutï¼‰(1 åˆ†é’Ÿè¶…æ—¶)
2.   **æ”¯ä»˜**ï¼šä»£ç è·¯å¾„ï¼ˆ`phone-bill-api/orderpathlogic.go`ï¼‰
     1.   è·å–è®¢å•ä¿¡æ¯
     2.   æ ¹æ®æ”¯ä»˜ç±»å‹é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
          1.   æ”¯ä»˜å®ï¼ˆapp/webï¼‰
          2.   å¾®ä¿¡ï¼ˆapp/webï¼‰
          3.   ä½™é¢
               1.   `billingRpc/UserWalletDeduct` æ›´æ–°ç”¨æˆ·é’±åŒ…ä½™é¢
               2.   æ›´æ–°æ”¯ä»˜ä¿¡æ¯(payment è¡¨)
3.   **è®¢å•å¤„ç†**ï¼šä»£ç è·¯å¾„ï¼ˆ`phone-bill-api/common.go -> OrderPaid`ï¼‰
     1.   åŒºåˆ†æ˜¯æ‰‹æœºè®¢å•è¿˜æ˜¯çº¿è·¯è®¢å•ï¼Œç»­è´¹è®¢å•è¿˜æ˜¯å……å€¼è®¢å•
     2.   çº¿è·¯è®¢å•ï¼šå°†ä»»åŠ¡ `asynq:order:process:v2` åŠ å…¥ `resource` é˜Ÿåˆ—ï¼Œpayload æºå¸¦ orderIdã€‚resource é˜Ÿåˆ— handler: `resource/asyncqserver.go.HandleOrderProcessTask`
          1.   æ ¹æ®è®¢å•å·æŸ¥æ‰¾è®¢å•ã€‚
          2.   æ ¹æ®ä»˜è´¹ç±»å‹ï¼Œè®¡ç®—æ­¤è®¢å•çš„æœ‰æ•ˆæœŸï¼ˆå¼€å§‹ã€ç»“æŸï¼‰ã€‚ï¼ˆ`billingRpc/CalcExpireDate`ï¼‰
          3.   åˆ›å»º resourceã€‚`createresourcelogic.CreateResource`
               1.    **åˆ›å»ºçº¿è·¯**ï¼š`create.go.CreateResource` ã€‚è°ƒç”¨ `turbolive-server/CreateUOLLine`ï¼Œå¾—åˆ°èµ„æº id
                    1.   è¯·æ±‚å‚æ•°ï¼šChargeType, Quantity, SourceRegion, DestRegion, LineId, LineType
                    2.   æ ¡éªŒ DestRegion æ˜¯å¦æ˜¯å½“å‰æ‰€æ”¯æŒçš„ç›®çš„åŒºåŸŸï¼ˆini é…ç½®æ–‡ä»¶ä¸­çš„ dest-region section é…ç½®ï¼‰
                    3.   æ ¹æ®ç›®çš„åŒºåŸŸå†³å®šä¸Šè½¦ç‚¹ï¼ˆsourceRegionï¼‰ `SourceRegionDecision` é»˜è®¤ä»å¹¿å·ä¸Šè½¦
                    4.   åœ¨ pathlive.lines è¡¨åˆ›å»º line è®°å½•ï¼ˆå¾ªç¯åˆ›å»º 3 æ¬¡ï¼ŒæˆåŠŸåˆ™åœæ­¢ï¼Œ**ä¸ºå•¥ï¼Ÿ**ï¼‰
                    5.   å¦‚æœåˆ›å»ºæˆåŠŸï¼Œå°† line çš„ç›¸å…³ä¿¡æ¯æ›´æ–°åˆ°è¯¥æ¡è®°å½•ä¸Šã€‚ï¼ˆå¾ªç¯æ›´æ–° 3 æ¬¡ï¼ŒæˆåŠŸåˆ™åœæ­¢ï¼Œ**ä¸ºå•¥ï¼Ÿ**ï¼‰
                         1.   å¦‚æœæ›´æ–°æˆåŠŸï¼Œä» ini é…ç½®æ–‡ä»¶ä¸­ `run-mode` section è¯»å–é…ç½®æ˜¯å¦éœ€è¦åˆ›å»º UHost
                              1.   åˆ›å»º UHost & EIPï¼Œåˆ›å»ºæˆåŠŸåˆ™ä¿å­˜ UHost ç›¸å…³ä¿¡æ¯åˆ° line è®°å½•ä¸Š ï¼ˆå¾ªç¯åˆ›å»º 10 æ¬¡ï¼ŒæˆåŠŸåˆ™åœæ­¢ï¼Œ**ä¸ºå•¥ï¼Ÿ**ï¼‰ã€‚å¹¶ä¸”æ ¹æ® uhostId å¼‚æ­¥è·å– IP
                                   1.   å¼‚æ­¥åˆ›å»º UHostï¼Œå°è¯• 3 æ¬¡
                                   2.   å¼‚æ­¥åˆ›å»º EIP
                                        1.   å¦‚æœæ˜¯é“‚é‡‘çº¿è·¯ï¼Œå°è¯• 3 æ¬¡ã€‚ä½¿ç”¨ EIP ç®¡ç†ç­–ç•¥é€‰å‡ºä¸€ä¸ª EIPï¼Œ é€»è¾‘å‚è€ƒï¼š**EIP ç®¡ç†** ç« èŠ‚
                                        2.   å…¶ä»–çº¿è·¯ï¼Œåˆ™åˆ†é… EIPã€‚é‡è¯• 5 æ¬¡è¿›è¡Œåˆ†é… IP `allocateEip`ã€‚ï¼ˆåŸå› æ˜¯ï¼š<u>å› æŒ‡å®šäº†å¤šä¸ªå¯ç”³è¯·çš„IPæ®µï¼Œä»¥é˜²æ­¢æŸä¸ªæ®µæ²¡IPäº†ï¼Œæˆ–è€…UCloudåå°æŠŠæŸä¸ªæ®µé”å®šç­‰æƒ…å†µï¼Œå¯¼è‡´ allocateEip å¤±è´¥ï¼Œå¤šé‡è¯•å‡ æ¬¡</u>ï¼‰
                                        3.   åˆ¤æ–­ UHostId & EIPId éƒ½åˆ›å»ºæˆåŠŸã€‚æœ‰åˆ™å°† EIP ç»‘å®šåˆ° UHost ä¸Šã€‚
                                             1.   å¦‚æœæ˜¯é“‚é‡‘è·¯çº¿ï¼Œéœ€è¦å°† EIP é‡ç½®ä¸ºä½¿ç”¨ä¸­çš„çŠ¶æ€ï¼ˆ`eip.UsedTime = now`ï¼‰ï¼Œå¹¶ä¸”å°†é»˜è®¤å¸¦å®½å¢åŠ åˆ° 10M
                                        4.   å¦åˆ™ï¼Œå°†åˆ›å»ºå¥½çš„ UHost æˆ–è€… EIP å¯¹åº”åˆ é™¤æ‰ï¼ˆéé“‚é‡‘çº¿è·¯çš„ EIP éœ€è¦é‡Šæ”¾ï¼‰
                              2.   å¦åˆ™éœ€è¦å›æ»š
                         2.   å¦åˆ™éœ€è¦å›æ»š
                    6.   åˆ›å»ºä¸æˆåŠŸéœ€è¦**å›æ»š** `rollback`ã€‚åˆ é™¤ line è®°å½•ã€‚**è®¡è´¹ã€èµ„æºç­‰å›æ»šæ“ä½œç”±ç½‘å…³å±‚å…¬å…±æœåŠ¡ç»Ÿä¸€å®ç°**
               2.   æ‰€æœ‰èµ„æº id å†™å…¥ resouce è¡¨
               3.   æ¯ä¸ª id éƒ½ä½œä¸ºä¸€ä¸ªä»»åŠ¡ï¼Œå†™å…¥ resouce é˜Ÿåˆ—ï¼Œäº‹ä»¶åï¼š`asynq:resource:create_check`ã€‚äº‹ä»¶handler: `resouce/asynqserver.HandleCreateCheckTask`
                    1.   æ ¹æ® resourceId æ‰¾åˆ° resource è¡¨ä¸­çš„ resource ä¿¡æ¯
                    2.   æ ¹æ® resourceId è¯·æ±‚ `turbolive-server/DescribeUOLLine` æ‰¾åˆ° resource å¯¹åº”çš„çº¿è·¯ä¿¡æ¯ï¼ˆipã€åŒºåŸŸï¼‰
                    3.   å¦‚æœè¯¥çº¿è·¯å¯ç”¨ï¼ˆline.Enableï¼‰ã€‚åœ¨ resouce è¡¨ä¸­æ ‡è®°è¯¥èµ„æºçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ï¼Œå¹¶è®¾ç½®è¯¥èµ„æºçš„è¿‡æœŸæ£€æŸ¥ä»»åŠ¡
                         1.   `utils.SetResourceExpire`ã€‚å¼‚æ­¥è¿›è¡Œã€‚å‘ resource é˜Ÿåˆ—æ³¨å†Œä¸€ä¸ªèµ„æºè¿‡æœŸçš„äº‹ä»¶ `asynq:resource:expired`ï¼Œ handler ä¸º `resource/asynqserver.HandleExpiredTask`ï¼Œæ‰§è¡Œæ—¶é—´ä¸ºè¿‡æœŸæ—¶é—´ï¼Œå³åœ¨è¿‡æœŸæ—¶é—´åˆ°çš„æ—¶å€™æ‰§è¡Œèµ„æºæ¸…ç†å·¥ä½œ
                              1.   å†æ¬¡æ£€æŸ¥è¿‡æœŸæ—¶é—´æ˜¯å¦åœ¨å½“å‰æ—¶é—´ä¹‹å‰ï¼Œå¦åˆ™å†æ¬¡è®¾ç½®è¿‡æœŸæ£€æŸ¥äº‹ä»¶ `utils.SetResourceExpire`ï¼ˆ**è¿‡æœŸæ—¶é—´å¯èƒ½è¢«ç»­è´¹ç­‰æ“ä½œæ›´æ–°**ï¼‰
                              2.   æ£€æŸ¥å½“å‰èµ„æºæ˜¯å¦æœ‰è®¾ç½®è‡ªåŠ¨ç»­è´¹ï¼Œæœ‰åˆ™è‡ªåŠ¨ç»­è´¹ `resource/asynqserver.autoRenew`
                              3.   å°†è¯¥èµ„æºåšå…³æœºæ“ä½œ `PowerOffResource`ï¼Œå®é™…æ‰§è¡Œçš„æ˜¯ `turbolive-server/SetUOLLineStatus`
                              4.   æ›´æ–° resource è¡¨ï¼Œæ ‡è¯†è¯¥èµ„æºå·²åˆ°æœŸ
                              5.   æ³¨å†Œ 7 å¤©ååˆ é™¤è¯¥èµ„æºçš„äº‹ä»¶ `utils.SetResourceExpireDelete`ï¼ˆå¦‚æœ 7 å¤©å†…é‡æ–°ç»­è´¹ï¼Œåˆ™è¯¥äº‹ä»¶è¢«åˆ é™¤ï¼‰
                                   1.   äº‹ä»¶ï¼š `asynq:resource:expired_delete` handlerï¼š`resource/asynqserver.HandleExpiredDeleteTask` ï¼Œä¸ƒå¤©åæ‰§è¡Œ
                                   2.   å†æ¬¡æ£€æŸ¥è¿‡æœŸæ—¶é—´ + 7 å¤©æ˜¯å¦åœ¨å½“å‰æ—¶é—´ä¹‹å‰ï¼Œå¦åˆ™å†æ¬¡è®¾ç½®è¿‡æœŸåˆ é™¤äº‹ä»¶ `utils.SetResourceExpireDelete` ï¼ˆ**ç†ç”±åŒä¸Š**ï¼‰
                                   3.   æ­¤æ—¶ä¸ç®¡è®¾å®šçš„è¿‡æœŸæ—¶é—´æ˜¯å¦çœŸçš„è¿‡æœŸï¼Œè¿‡æœŸåˆ™è®¾ç½®ä¸º"**å·²åˆ é™¤**"çŠ¶æ€ï¼Œå¦åˆ™è®¾ç½®ä¸º"**æå‰åˆ é™¤**"çŠ¶æ€ã€‚
                                        1.   è°ƒç”¨ `turbolive-server/DeleteUOLLine` æ‰§è¡Œå®é™…åˆ é™¤æ“ä½œ
                                             1.   ä» pathlive.lines è¡¨ä¸­è·å–çº¿è·¯ä¿¡æ¯
                                             2.   æ›´æ–°å…¶çŠ¶æ€ä¸ºä¸å¯ç”¨ï¼ŒvpcIp ä¸º"åˆ é™¤ä¸­"
                                             3.   å¼‚æ­¥æ‰§è¡Œåˆ é™¤ã€‚
                                                  1.   å¦‚æœæ˜¯é“‚é‡‘çº¿è·¯ï¼Œåˆ™ä¸åˆ é™¤ EIP, åªæ˜¯å°†çº¿è·¯çš„å¸¦å®½å˜ä¸º 1M(**è¿æ¥ UCloud æ“ä½œ**)ï¼Œ å¹¶æ ‡è®° lastReleaseTime ä¸ºå½“å‰æ—¶é—´
                                                  2.   å¦åˆ™åˆ é™¤äº‘ä¸»æœºï¼ˆ**UHost**ï¼‰
                                                  3.   é€»è¾‘åˆ é™¤ lines è¡¨è®°å½•ï¼ˆåˆ é™¤åæ¬¡ï¼Œä¸€æ¬¡æˆåŠŸåˆ™åœæ­¢ï¼Œ**ä¸ºå•¥ï¼Ÿ**ï¼‰
                                        2.   resource è¡¨åšé€»è¾‘åˆ é™¤ï¼ˆ`resouce.Deleted = 1`ï¼‰
                    4.   å¦‚æœä¸å¯ç”¨ã€‚æŸ¥çœ‹è¯¥ä»»åŠ¡çš„é‡è¯•æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡ 90 æ¬¡è¿˜æœªæˆåŠŸï¼Œåˆ™æ ‡è®°å½“å‰èµ„æºåˆ›å»ºçŠ¶æ€ä¸ºå¤±è´¥ï¼Œæ›´æ–°åˆ° resource è¡¨ä¸­

##### UHost  & EIP 

äº‘ä¸»æœºç”¨æ¥èµ°æµé‡ï¼ŒEIP ä½œä¸ºè¯¥æµé‡çš„èµ·å§‹åœ°å€



##### EIP ç®¡ç†

`eip_manage.FindOneUsableEipWithRegion`

ä» `pathlive.eips` è¡¨ä¸­æŸ¥æ‰¾ä¸€ä¸ªæŒ‡å®šåŒºåŸŸçš„ EIPï¼Œ å¹¶ä¸”æ»¡è¶³æ¡ä»¶ï¼š `usable = true and last_release_time < now - eip_lock_days ` ï¼Œå¹¶ä»ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª

å…¶ä¸­ï¼šusable æ˜¯éæ—¶é—´æ¡ä»¶ç®¡æ§ï¼Œå¯èƒ½æ˜¯å‡ºäºå…¶ä»–åŸå› éœ€è¦ç¦ç”¨è¯¥ EIP, last_release_time æ˜¯æ—¶é—´æ¡ä»¶çš„ç®¡æ§ 



##### è®¡ä»·è§„åˆ™

`billingRpc.GetPurchasePriceV2` 

1.   å‚æ•°ï¼šUserId, PricingId, ChargeType, Count(è´­ä¹°æ•°é‡)



#### åˆ›å»ºè¿æ¥ï¼ˆä½¿ç”¨çº¿è·¯ï¼‰

>   è¿æ¥è¿‡ç¨‹ï¼š
>
>   ä»å›½å†…çš„ä¸Šè½¦ç‚¹ï¼ˆæº IPï¼‰åˆ°è½¬å‘æœºï¼ˆä¸€èˆ¬æ˜¯é¦™æ¸¯çš„æœºå™¨ï¼‰ï¼Œå†åˆ°ä¸‹è½¦ç‚¹ï¼ˆå›½å¤–çš„æœºå™¨ï¼‰
>
>   å…¶ä¸­ï¼Œä¸Šè½¦ç‚¹çš„ç«¯å£å’Œè½¬å‘æœºä¸Šçš„ç«¯å£ä¸€ä¸€å¯¹åº”ã€‚è½¬å‘æœºåˆ°ä¸‹è½¦ç‚¹çš„ç«¯å£ä¸´æ—¶åˆ†é…



`turbolive-server/CreateUOLConnection`

1.   ä»è¯·æ±‚å‚æ•°ä¸­è·å– line Token, å¹¶ä» pathlive.line_tokens è¡¨è·å–è¯¥ token çš„è®°å½•
2.   æ ¹æ® token ä¸­è®°å½•çš„ lineId åˆ° pathlive.lines è¡¨ä¸­æŸ¥è¯¢ line ä¿¡æ¯
3.   åˆ›å»ºé“¾æ¥å‰ï¼Œå¦‚æœè¯¥çº¿è·¯ä¹‹å‰å­˜åœ¨è¿æ¥ï¼ˆè¿æ¥æœªå…³é—­ï¼‰ï¼Œåˆ™å…ˆå…³é—­è¿æ¥ï¼ˆ`pathlive.connections.active = false`ï¼‰
4.   å°è¯•é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ä¸­è½¬æœºä»¥åŠæœªè¢«ä½¿ç”¨çš„ç«¯å£ `forward_server.OccupyOnePort`
     1.   åˆ›å»º WireGuardï¼ˆä¸€ç§ VPNï¼‰ é…ç½®ã€‚è®¾ç½®ç›®æ ‡ DNS (DestDNS)(ini æ–‡ä»¶é…ç½®å¥½çš„)
     2.   å¾ªç¯ 10 æ¬¡å°è¯•è·å–ä¸­è½¬æœºã€è¿æ¥
          1.   **å¯»æ‰¾ä¸­è½¬æœº**ï¼šä» `pathlive.forward_servers` è¡¨ä¸­é€‰å–å¯ç”¨çš„ä¸­è½¬æœºã€‚æ‰¾ä¸åˆ°åˆ™è¡¨ç¤ºçº¿è·¯å…¨å¿™ï¼Œåˆ™ä¸­æ­¢å¯»æ‰¾
               1.   èµ·å§‹åŒºåŸŸå’ŒæŒ‡å®šçš„èµ·å§‹åŒºåŸŸä¸€è‡´çš„
               2.   å½“å‰ä¸­è½¬æœºä¸Šçš„è¿æ¥ä¸è¶…è¿‡ 200 ï¼ˆrun-mode.max_load è®¾å®šï¼‰çš„
          2.   **å¯»æ‰¾å¯ç”¨ç«¯å£**ï¼šä»æ‰¾åˆ°çš„è½¬å‘æœºä¸­æ‰¾ä¸€ä¸ªç©ºé—²çš„ç«¯å£ `FindForwardServerPort`
               1.   è·å–é…ç½® `run-mode.fs-start-port` è¡¨ç¤º**èµ·å§‹ç«¯å£**
               2.   æ‰¾åˆ°è¯¥è½¬å‘é›†ç¾¤ï¼ˆforward_serverï¼‰ä¸Šæœ€åä¸€æ¬¡ä½¿ç”¨çš„è¿æ¥ä¿¡æ¯ï¼ˆ `pathlive.connections` è¡¨ï¼‰ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªç«¯å£
               3.   æ‰¾åˆ°è¯¥è½¬å‘æœºä¸Šæ‰€æœ‰å¯ç”¨çš„è¿æ¥ï¼Œå¦‚æœæ²¡æœ‰åœ¨ç”¨è¿æ¥ï¼Œåˆ™**èµ·å§‹ç«¯å£**å°±æ˜¯å¯ç”¨çš„ï¼Œè¿”å›å³å¯
               4.   æŒ‰é¡ºåºï¼Œåœ¨ maxLoad ä¸ªç«¯å£ä¸­æ‰¾ä¸€ä¸ªæ²¡æœ‰åœ¨ç”¨çš„ç«¯å£ï¼ˆåœ¨ç”¨çš„ç«¯å£åœ¨æŸ¥å‡ºæ¥çš„æ‰€æœ‰ connecting ä¸­æœ‰è®°å½•ï¼‰
          3.    **wireguard é…ç½®**ï¼šï¼ˆè½¬å‘æœºçš„ä¸Šè½¦ç‚¹ IP, æ‰¾åˆ°çš„å¯ç”¨ç«¯å£ï¼Œä½œä¸º wireguard çš„å…¥å£è®¾ç½®ï¼‰
          4.   **ç”Ÿæˆ connection å¯¹è±¡**ï¼šå¹¶å°†è¯¥è®°å½•æ’å…¥ `pathlive.connections` è¡¨ä¸­ï¼ˆå°è¯•æ’å…¥ 20 æ¬¡ï¼ŒæˆåŠŸåˆ™åœæ­¢ï¼‰ã€‚connection è¡¨ä¼šè®°å½•è¿æ¥ä½¿ç”¨çš„**ä¸Šè½¦ç‚¹ä¿¡æ¯ï¼Œè½¬å‘æœºä¿¡æ¯ï¼Œwireguard é…ç½®**
          5.   æ£€æµ‹åˆšåˆ›å»ºçš„è¿æ¥æ˜¯å¦å¯ç”¨ã€‚ï¼ˆ**æ­¤æ—¶è½¬å‘æœºåŠå…¶ç«¯å£è¿˜æ²¡æ­£å¼ä½¿ç”¨ï¼Œåªæ˜¯åœ¨ DB ä¸­è®°å½•å°†è¢«ä½¿ç”¨**ï¼‰
               1.   æŸ¥è¯¢è¯¥è½¬å‘æœºè¯¥ç«¯å£ä¸Šçš„å¯ç”¨è¿æ¥æ˜¯å¦åªæœ‰ä¸€ä¸ªï¼ˆåˆšåˆ›å»ºçš„é‚£ä¸€ä¸ªï¼‰ï¼Œè‹¥æœ‰å¤šä¸ªï¼Œåˆ™è¯´æ˜è¯¥ç«¯å£æ”¹è½¬å‘æœºè¢«å ç”¨ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å°è¯•
               2.   æŸ¥è¯¢è¯¥çº¿è·¯ä¸Šçš„å¯ç”¨è¿æ¥æ˜¯å¦åªæœ‰ä¸€ä¸ªï¼ˆåˆšåˆ›å»ºçš„é‚£ä¸ªï¼‰ï¼Œè‹¥æœ‰å¤šä¸ªï¼Œåˆ™è¯´æ˜è¯¥çº¿è·¯æœ‰å¤šä¸ªè¿æ¥åœ¨ä½¿ç”¨ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ¬¡å°è¯•ï¼ˆ**ä¸€ä¸ªçº¿è·¯åªæ”¯æŒä¸€ä¸ªè¿æ¥çš„æ—¶å€™ï¼Œéœ€è¦æ£€æµ‹çº¿è·¯çš„å ç”¨æƒ…å†µã€‚ä½†æ˜¯å½“å‰é‡‡ç”¨çš„æ˜¯åä¸€ä¸ªè¿æ¥ä¼šæŒ¤æ‰å‰ä¸€ä¸ªçš„ç­–ç•¥ï¼Œæ‰€ä»¥æ­¤å¤„æ£€æµ‹çº¿è·¯å ç”¨æƒ…å†µçš„åŠŸèƒ½å¯ä»¥å»é™¤**ï¼‰
5.   `DeployForwardServer` å¯¹æ‰¾åˆ°çš„è½¬å‘æœºè¿›è¡Œ ssh é…ç½®ä¸‹å‘éƒ¨ç½²ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
     1.   æ‰¾åˆ°è¯¥è¿æ¥å¯¹åº”çš„çº¿è·¯ & è½¬å‘æœºï¼ˆrelay,forward_serverï¼‰
     2.   éƒ¨ç½²ï¼š
          1.   **åœ¨ä¸‹è½¦ç‚¹éƒ¨ç½² wireguard server**ï¼Œç”¨äº VPNï¼ˆclient æ˜¯ app åœ¨ç›´æ’­æ—¶åˆ›å»ºï¼Œè¿æ¥è¿™ä¸ª server ï¼‰
               1.   ç”Ÿæˆ wireGuard ç™½åå•ã€‚æ ¹æ®çº¿è·¯çš„ serviceType é€‰æ‹©ç™½åå•ï¼ˆTK-1, TK-2ï¼‰
                    1.   å¦‚æœè¯¥è´¦æˆ·æœ‰é…ç½®ç™½åå•è¦†ç›–çš„ï¼Œåˆ™ä»¥è¿™ä¸ªé…ç½®çš„ä¸ºå‡†
                    2.   è·å–ç™½åå•è¯¦ç»†åˆ—è¡¨ `GetWhiteListConf(ServiceType)`  ï¼ˆ**åœ¨ç™½åå•ä¸­çš„åœ°å€æ˜¯å¯ä»¥é€šè¿‡çš„ï¼Œå…¶ä»–çš„éƒ½ä¼šè¢«é˜»æ‹¦**ï¼‰
                         1.   æ”¯æŒå¤šä¸ª serviceType, ç”¨é€—å·åˆ†å¼€
                         2.   åˆ° `pathlive.white_lists` è¡¨ä¸­æŸ¥è¯¢æŒ‡å®š serviceType çš„ç™½åå•ï¼Œå¹¶æ‹¼æˆç‰¹å®šæ ¼å¼çš„å­—ç¬¦

                    3.   å°†ç™½åå•ç”Ÿæˆå†™å…¥ wireGuard çš„ç™½åå•é…ç½®æ–‡ä»¶ä¸­çš„å‘½ä»¤ `echo <whitelist> > /path/to/wireguard/whitelit.conf`

               2.   åœ¨ä¸‹è½¦ç‚¹éƒ¨ç½² wireGuard server, å°è¯• 10 æ¬¡ï¼Œä»»ä½•ä¸€æ¬¡éƒ¨ç½²æˆåŠŸå°±åœæ­¢
                    1.   é»˜è®¤èµ°é¦™æ¸¯ä»£ç†ï¼Œå¹¶ä¸”åœ¨å¤šæ¬¡å°è¯•ä¸­ï¼Œä»£ç†å’Œç›´è¿çš„æ–¹å¼äº¤æ›¿è¿›è¡Œï¼Œå¯ä»¥åœ¨éƒ¨ç½²å¤±è´¥ä¸‹æ¬¡å°è¯•æ—¶å¤šä¸€ç§é€‰æ‹©
                    2.   ssh è¿æ¥åˆ°ä¸‹è½¦ç‚¹çš„æœºå™¨ã€‚ï¼ˆip: line.bgpIp, port: 22ï¼‰ã€‚
                         1.   å¦‚æœä½¿ç”¨ä»£ç†ã€‚åˆ™ä½¿ç”¨å†…å»ºçš„ä»£ç†æœåŠ¡å™¨è¿›è¡Œè¿æ¥ï¼ˆini ä¸­é…ç½® xx-proxyï¼‰,é€šè¿‡ä»£ç†è¿æ¥ä¸‹è½¦ç‚¹å…¬ç½‘ IPï¼ˆip: line.bgpIp, port: 22ï¼‰
                         2.   å¦åˆ™é€šè¿‡ä¸‹è½¦ç‚¹çš„å…¬ç½‘ IP ç›´è¿ï¼ˆip: line.bgpIp, port: 22ï¼‰

                    3.   è¿è¡Œå‘½ä»¤ï¼Œéƒ¨ç½² wireGuard server (**æœ¬æ¬¡è¿æ¥ä¼šæŒ¤æ‰ä¸Šä¸€æ¬¡çš„è¿æ¥**)
                         1.   åœæ­¢å·²æœ‰çš„ wireGuard server
                         2.   ç™½åå•é…ç½®å†™å…¥é…ç½®æ–‡ä»¶
                         3.   é‡å¯ wireGuard server

          2.   **åœ¨ä¸­è½¬æœºéƒ¨ç½² socat,** ç”¨äºæµé‡è½¬å‘ã€‚å°è¯• 10 æ¬¡ï¼Œä»»ä½•ä¸€æ¬¡éƒ¨ç½²æˆåŠŸå°±åœæ­¢
               1.   é€‰æ‹©ä¸­è½¬æœºçš„ç›®æ ‡ IP `GetDestRelayIp`ï¼Œ æœ€ç»ˆä¸­è½¬åˆ°çš„ IPï¼ˆä¸‹è½¦ç‚¹ï¼‰
               2.   é»˜è®¤èµ°ä»£ç†ï¼Œ ssh è¿æ¥ä¸­è½¬æœº
               3.   æ‰§è¡Œå‘½ä»¤ï¼Œéƒ¨ç½² socat
                    1.   åœæ­¢å­˜åœ¨çš„ socat
                    2.   å°†ä¸­è½¬æœºçš„ç›®æ ‡ IP å†™å…¥ socat çš„é…ç½®ï¼ˆæœ€ç»ˆæµé‡è½¬åˆ°çš„ IPï¼‰ `GenerateRelaySystemd`
                    3.   é‡å¯ socat ï¼Œä½¿é…ç½®ç”Ÿæ•ˆ

     3.   å¦‚æœ wireguard server å’Œ socat éƒ½éƒ¨ç½²å¥½äº†ã€‚å°†æ­¤æ¡è¿æ¥çš„ä¿¡æ¯å†™å…¥  `pathlive.connections` è¡¨


#### ä¸­æ–­è¿æ¥

`tubrolive-server/TerminateUOLConn`

å°†è¿æ¥çš„ active ç½®ä¸º false å³å¯ã€‚æœºå™¨ä¸Šå®‰è£…çš„ wireguard & socat ä¸‹æ¬¡ä½¿ç”¨çš„æ—¶å€™ä¼šè¦†ç›–

#### çº¿è·¯æµé‡æ˜¯æ€ä¹ˆèµ°çš„

åœ¨è¿æ¥åˆ›å»ºå¥½ä¹‹åï¼Œæœ‰å‡ ä¸ªé‡è¦çš„ç‚¹

1.   å®¢æˆ·ç«¯ wireguard é…ç½®

```txt
[Interface]
Address = 10.13.13.2   (æ ‡è¯†å½“å‰çŸ­ç‚¹ VPN IP)
PrivateKey = cMBcS9bDJ1u4aLp1VCf+we6t4fXfi5s7v93poGxv/XU=
DNS = 8.8.8.8
MTU = 1392

[Peer]
PublicKey = YnaDr0SXsp3OKD2i0XP3z7dUUHVGDlAs7+xQ3ZOHu2E=
Endpoint = <ä¸Šè½¦ç‚¹ IP>:30258   (ä¸Šè½¦ç‚¹ IP)
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 30
```

 æ­¤å¤„é…ç½®ï¼Œå°†ç”¨æˆ·å®¢æˆ·ç«¯å’Œä¸Šè½¦ç‚¹è”é€šã€‚ï¼ˆä¸Šè½¦ç‚¹ä½œä¸º wireguard çš„ä¸­ç»§æœåŠ¡å™¨ï¼‰

2.   ä¸Šè½¦ç‚¹é¢„å…ˆè¿è¡Œå¥½ socat ï¼Œå°†æµé‡è½¬å‘åˆ°ä¸­è½¬æœº

ä½¿ç”¨è„šæœ¬é¢„å…ˆç”Ÿæˆï¼Œå…·ä½“ systemd é…ç½®ï¼Œåœ¨ä¸Šè½¦ç‚¹æœºå™¨æ ¹ç›®å½•ä¸‹ a.sh æ–‡ä»¶å†…ï¼Œé…ç½®å¤§è‡´å¦‚ä¸‹ï¼š

```txt
[Unit]
Description=Socat Wireguard 30258

[Service]
Type=simple
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=socat-wireguard-30258

ExecStart=/usr/bin/socat -T 600 UDP4-LISTEN:30258,reuseaddr,fork UDP4:<ä¸­è½¬æœº IP>:30258
Restart=always

[Install]
WantedBy=multi-user.target
```

3.   ä¸­è½¬æœºä¸Šçš„ socat å†å°†æµé‡è½¬å‘åˆ°ä¸‹è½¦ç‚¹ï¼ˆ**åˆ›å»ºè¿æ¥æ—¶éƒ¨ç½²**ï¼‰



## operation-api

è¿è¥åç«¯ api



### çº¿è·¯æŠ“åŒ…åŠŸèƒ½

æœ€ç»ˆå®ç°ï¼š`pathlive-rpc/LineTcpDump` 

å®ç°ï¼š é¡ºç€ä¸­é—´èŠ‚ç‚¹ä¸€ä¸ªä¸ªè¿è¿‡å»

åŸå› ï¼šå½“ç„¶å¯ä»¥ç›´æ¥é€šè¿‡å…¬ç½‘è¿æ¥ä¸‹è½¦ç‚¹æœºå™¨ï¼Œæ‰§è¡Œ tcpdump å‘½ä»¤è¿›è¡ŒæŠ“åŒ…ï¼Œä½†æ˜¯æŠ“åŒ…çš„ç»“æœå›ä¼ ï¼Œå¦‚æœç›´æ¥åœ¨ä¸‹è½¦ç‚¹ä¸Šä¼ ï¼Œåˆ™ä¼šä½¿ç”¨ä¸‹è½¦ç‚¹æœºå™¨çš„å¸¦å®½ï¼Œå¯èƒ½ä¼šå½±å“ç”¨æˆ·çš„æ­£å¸¸ä½¿ç”¨ã€‚æ‰€ä»¥æŠ“åŒ…æ—¶ï¼Œä¼šé¡ºç€ä»£ç†çš„ä¸€ä¸ªä¸ªèŠ‚ç‚¹æ„å»ºä¸€æ¡é€šé“ï¼Œæœ€ç»ˆæŠ“åŒ…çš„ç»“æœé¡ºç€é€šé“è¿”å›ï¼ˆé€šé“ä¸€èˆ¬ä¼šèµ° Ucloud ä¸“çº¿ï¼Œä¹Ÿå« UDPN,UCloud Dedicated Private Networkï¼‰



#### è·å–æŠ“çš„åŒ…

`operation-api/tcpdump ï¼ˆgetï¼‰` è·å–ç”Ÿæˆçš„åŒ…ã€‚æŠ“å¥½çš„åŒ…ä¼šå­˜æ”¾åœ¨ ofileos ä¸Šã€‚`pathlive.tcpdump` è¡¨å­˜æ”¾æ–‡ä»¶å

## UserCenter

ç”¨æˆ·ä¸­å¿ƒ

ç”¨æˆ·ç±»å‹(`usercenter/userinfologin.go`)ï¼š

```text
// è´¦å·ç±»å‹åˆ†è¿™äº›
// - ç›´é”€å®¢æˆ·
// - æ¸ é“1ï¼šUCloud SMLã€UCLOUD EIUã€UCLOUD XXã€ç‹ç£Šã€ä»¥åŠç¦»èŒé”€å”®ç»„æˆçš„å…¼èŒå°å›¢é˜Ÿ
//                  è¿™ç±»å®¢æˆ·ä¼šç»™æˆ‘ä»¬å¸¦æ¥ç»ˆç«¯å®¢æˆ·ï¼Œä¹Ÿä¼šå¸¦æ¥ä»£ç†å•†ã€‚å®¢æˆ·å’Œæ”¶å…¥éƒ½èµ°æˆ‘ä»¬è¿™é‡Œ
//                  ä¸»è´¦å·å’Œå­è´¦å·åˆ†åˆ«ç”¨äºçœ‹æ•´åˆå’Œåä¸‹é”€å”®çš„å®¢æˆ·æƒ…å†µï¼Œé€šè¿‡é‚€è¯·ç å…³è”å®¢æˆ·
//                  æˆ‘ä»¬ä¸€èˆ¬ç»™è¿™ç±»æ¸ é“å›ºå®šæŠ˜æ‰£ï¼ŒæŠ˜æ‰£ä¹‹ä¸Šå±äºæ¸ é“çš„åˆ©æ¶¦ã€‚æš‚å®šé•¿æœŸè¿”æ¯›åˆ©
// - æ¸ é“2ï¼šUCLOUDç¦»èŒé”€å”®æˆ–æœ‹å‹
//                  å’Œæ¸ é“1å¾ˆç±»ä¼¼ï¼Œå¸¦æ¥çš„å®¢æˆ·æœ‰å¯èƒ½æ˜¯ç»ˆç«¯å®¢æˆ·ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä»£ç†å•†ã€‚å®¢æˆ·å’Œæ”¶å…¥éƒ½èµ°æˆ‘ä»¬è¿™é‡Œ
//                  åŒºåˆ«åœ¨äºè¿”ä½£æ–¹å¼ä¸ä¸€æ ·ï¼Œæ¸ é“1ä¾§é‡äºé•¿æœŸåˆä½œï¼Œæš‚å®šé•¿æœŸè¿”ï¼›æ¸ é“2åˆ™æ˜¯çŸ­æœŸè¡Œä¸ºï¼Œæ¯”å¦‚è¿”ä¸‰ä¸ªæœˆå†…æ¯ä¸ªæœˆæœˆé”€30%
// - ä»£ç†ï¼šåœ¨æˆ‘ä»¬è¿™é‡Œä½“ç°ä¸ºå•ä¸ªå®¢æˆ·ï¼Œä»–çš„å®¢æˆ·æˆ‘ä»¬çœ‹ä¸è§
//                  ç›´æ’­å¿«æœ‰ä¸€äº›ä»£ç†ï¼Œæ¯”å¦‚æ­£å¿ƒï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°æ­£å¿ƒçš„ç»ˆç«¯å®¢æˆ·æƒ…å†µ
//                  ä»£ç†è‡ªè¡Œç»´æŠ¤å®¢æˆ·å…³ç³»ï¼Œå¹¶è§£å†³å®¢æˆ·å”®åé—®é¢˜
```

### RPC

åŒ…å«åŠŸèƒ½ï¼š 

1.   ç”¨æˆ·
2.   ç¾¤ç»„ï¼šgroup è¡¨
3.   é‰´æƒï¼šä½¿ç”¨ Redis åš token è¿‡æœŸæ§åˆ¶ï¼ˆä¸€ä¸ªæœˆè¿‡æœŸï¼Œ 2592000 ç§’ï¼‰
4.   å®åè®¤è¯ï¼š user è¡¨ & certification è¡¨
5.   èµ„æºè¿‡æœŸé€šçŸ¥ï¼šèµ„æºå¿«åˆ°æœŸæˆ–è€…å·²ç»åˆ°æœŸï¼Œé€šè¿‡çŸ­ä¿¡é€šçŸ¥ç”¨æˆ·åŠæ—¶å……å€¼ã€‚æ­¤å¤„ä¸ç®¡æ˜¯å¦è‡ªåŠ¨ç»­è´¹çš„é€»è¾‘ï¼Œå¦‚æœè®¾ç½®çš„è‡ªåŠ¨ç»­è´¹ï¼Œä½†æ˜¯ä½™é¢ä¸è¶³ï¼Œä¹Ÿéœ€è¦è¿›è¡Œé€šçŸ¥ã€‚æ„é€ çŸ­ä¿¡æ¨¡æ¿
     1.   åˆ°æœŸå‰ 3 å¤©è¿›è¡Œé€šçŸ¥ï¼Œåˆ°æœŸå 4 å¤©è¿›è¡Œèµ„æºåˆ é™¤
6.   æ¸ é“ç”¨æˆ·ç®¡ç†ï¼ˆä»£ç†å•†ï¼‰ï¼ˆuser è¡¨ channel ç›¸å…³å­—æ®µï¼‰
7.   ç³»ç»Ÿé€šçŸ¥ï¼šä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººé€šçŸ¥

### API

-   [ ] âš ï¸éœ€è¦äº†è§£æ¸ é“ & ä»£ç†ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

åŒ…å«åŠŸèƒ½ï¼š

1.   å¾®ä¿¡ã€QQç¬¬ä¸‰æ–¹ç™»å½•ï¼Œè·å– UnionId å­˜åˆ° user è¡¨é‡Œ
2.   å‘ç¥¨æœåŠ¡ï¼šå‘ç¥¨ä¿¡æ¯ç®¡ç† & å¡ç¥¨å¯å¼€ç®¡ç†ï¼Œå‘é€é€šçŸ¥ï¼Œæé†’ç›¸å…³äººå‘˜è¿›è¡Œå¼€ç¥¨æ“ä½œ
     1.   invoice è¡¨ï¼šå‘ç¥¨åŠé‡‘é¢è¡¨
     2.   invoice_info è¡¨ï¼š å‘ç¥¨æœ¬èº«çš„ä¿¡æ¯ï¼Œä¸€èˆ¬æ˜¯å·²ç»å¼€å…·çš„å‘ç¥¨è®°å½•
3.   ğŸŸªæ¸ é“ï¼ˆä»£ç†å•†ï¼‰æ¸ é“ A: Ucloud é”€å”®ï¼Œç›´æ¥è¿”ç°é‡‘ï¼›æ¸ é“ B: 
     1.   æ¸ é“ Aï¼š
          1.   è·å–æ¸ é“ä¿¡æ¯`channel.GetChannelDataByUserId`ï¼ˆæŒ‡å®šç”¨æˆ·çš„è¿™ä¸ªæ¸ é“ï¼‰ï¼šæ‰€æœ‰ä¸‹çº§ç”¨æˆ·ï¼ŒæŠ˜æ‰£ï¼Œè¿”åˆ©ï¼Œæ‰€æœ‰å¯ç”¨èµ„æºï¼ˆçº¿è·¯ & äº‘æ‰‹æœºï¼‰
          2.   è·å–æ¸ é“æ¶ˆè´¹ä¿¡æ¯`channel.GetChannelConsumptionByInviter`: **æŒ‡å®šæ—¶é—´æ®µå†…**çš„æ‰€æœ‰ä¸‹çº§ç”¨æˆ·çš„çº¿è·¯ & æ‰‹æœºèµ„æºåŠå…¶æ—¶é—´æ®µå†…çš„æ¶ˆè´¹ä¿¡æ¯ã€‚æ¶ˆè´¹ä¿¡æ¯åŒ…æ‹¬ï¼š
               1.   è®¢å•é‡‘é¢ï¼Œç»­è´¹é‡‘é¢â€¦â€¦è®¡ç®—æ–¹å¼ï¼š`GetConsumptionAndCalcTime`
          3.   è·å–æ¸ é“ç”¨æˆ·è¿”åˆ© `GetChannelBonusByInviter`: æŒ‡å®šæ—¶é—´æ®µå†…çš„æ‰€æœ‰ä¸‹çº§ç”¨æˆ·çš„è¿”åˆ©æ€»å’Œã€‚è®¡ç®—æ–¹å¼ï¼šä½¿ç”¨ç”¨æˆ·è´­ä¹° & å……å€¼çš„æ€»é‡‘é¢è¿›è¡Œè®¡ç®—
          4.   è·å–æ¸ é“ç”¨æˆ·çš„æ”¯ä»˜ä¿¡æ¯ `GetChannelPaymentByInviter`
     2.   æ¸ é“ B: åˆ†ä¸ºç›´é”€å’Œä»£ç†ã€‚é€»è¾‘ç±»ä¼¼ï¼Œåªæ˜¯è¿”åˆ©ä¸ä¸€æ ·
4.   å­è´¦å·ï¼š
     1.   åˆ›å»º`createsublogic.go`ï¼šè´¦å·åï¼šç”¨æˆ·å + @ä¸»è´¦å·
     2.   åˆ é™¤ `deletesublogic.go`ï¼šåŒæ—¶å›æ”¶å…¶åä¸‹èµ„æº
     3.   ç™»å½•`subloginlogic.go`: å¯†ç åšç‰¹æ®Šå¤„ç†ï¼Œè®°å½•ç™»å½•
5.   è€æ¨æ–°æ´»åŠ¨ï¼šç”¨æˆ·è¡¨é‡Œï¼Œchannel_inviter ä¸ºç©ºï¼Œå¹¶ä¸”æœ‰å…·ä½“çš„é‚€è¯·äºº inviter ä¸ºé‚€è¯·äººçš„ userId
6.   ç”¨æˆ·å……å€¼ï¼š
7.   ç™»å½•æ³¨å†Œ`registerlogic.go`ï¼š ç™»å½•å’Œæ³¨å†Œæ´»åŠ¨éƒ½éœ€è¦è®°å½•åˆ°è¡¨é‡Œã€‚æ”¯æŒé‚€è¯·ç ï¼Œæ¸ é“åˆ†é”€åŠå…¶æ¸ é“å®šçº§ï¼ˆchannel_invite_levelï¼‰
8.   éªŒè¯ç ï¼šéªŒè¯ç å­˜åœ¨ Redis ä¸­ï¼Œä»¥æ‰‹æœºå·ä¸º key,  3 åˆ†é’Ÿè¿‡æœŸ
9.   ç”¨æˆ·ä½™é¢





## Order & phone-bill-api

ç”¨äºå¤„ç†å„ç§è®¢å• & è´¦å•çš„ api



### Order

**ç°åœ¨è¯¥é¡¹ç›®ä¸­çš„æ¥å£åŸºæœ¬æ²¡æ€ä¹ˆä½¿ç”¨ï¼Œä¸»è¦ç”¨æ¥æä¾›è®¢å•ç›¸å…³çš„å®ä½“**

#### é€€æ¬¾

refund è¡¨

é‡è¦å­—æ®µè¯´æ˜ï¼š

| å­—æ®µå |    å«ä¹‰    |                å¤‡æ³¨                 |
| :----: | :--------: | :---------------------------------: |
| total  | æ€»é€€æ¬¾é‡‘é¢ | å•ä½ï¼šåˆ†ï¼›æä¾›ç»™å…¶ä»–æœåŠ¡æ—¶å« refund |
| count  |  é€€æ¬¾æ•°é‡  |                                     |
|  all   | è®¢å•æ€»é‡‘é¢ | å•ä½ï¼šåˆ†ï¼›æä¾›ç»™å…¶ä»–æœåŠ¡æ—¶å« total  |

é€€æ¬¾æ—¶ï¼Œè®¡ç®—å¥½åº”é€€é‡‘é¢ï¼Œåœ¨ refund è¡¨ä¸­è®°å½•ä¸€ç¬”ï¼Œå‘é€å¼‚æ­¥é€šçŸ¥ï¼š

1.   é€šçŸ¥ Key: `asynq:order:refund`
2.   é˜Ÿåˆ—ï¼š `payment` 
3.   payload: refundId
4.   å¤„ç†é€»è¾‘: `phone-bill-api/asyncserver.HandleOrderRefundTask`  (**è¯¥é€€æ¬¾é€»è¾‘å·²å¯ç”¨ã€‚ç”¨äºåŸå…ˆåˆ›å»ºèµ„æºå¤±è´¥æ—¶è‡ªåŠ¨é€€æ¬¾ï¼Œç°åœ¨æ²¡æœ‰è‡ªåŠ¨é€€æ¬¾ï¼Œåªæœ‰è¿è¥å¹³å°å¯ä»¥æ“ä½œé€€æ¬¾**)
     1.   æ ¹æ® refundId æŸ¥è¯¢ refund è¯¦æƒ…ï¼ˆåˆ›å»ºé€€æ¬¾å•æ—¶å†™å…¥çš„è®°å½•ï¼‰
     2.   æ ¹æ®è®¢å•ä¿¡æ¯æ‰¾åˆ°è¿™ä¸ªè®¢å•çš„æ”¯ä»˜ä¿¡æ¯
          1.   ç¡®è®¤æ˜¯å¦å·²ç»æ”¯ä»˜ï¼Œä»¥åŠæ”¯ä»˜é‡‘é¢
          2.   ç¡®è®¤æ”¯ä»˜æ–¹å¼ï¼ŒåŸè·¯é€€å›



### phone-bill-api

ä¸»è¦æœ‰è®¢å•å¤„ç†ã€æ”¯ä»˜å¤„ç†ã€ç»­è´¹ã€å……å€¼ã€è®¡ä»·ç­‰åŠŸèƒ½



#### ç»­è´¹â€”â€”çº¿è·¯

`phone-bill-api/orderrenewlogic.OrderRenew`  æ”¯æŒæ‰¹é‡ç»­è´¹ã€æ”¯æŒæ‰‹æœº & çº¿è·¯ç»­è´¹ã€‚æ­¤å¤„åªå…³æ³¨çº¿è·¯ç»­è´¹é€»è¾‘ã€‚åˆ—ä¸¾éœ€è¦å…³æ³¨çš„å‡ ä¸ªç‰¹æ®Šç‚¹ã€‚

1.   åˆ›å»º **parentId**ã€‚å› ä¸ºæ”¯æŒæ‰¹é‡ç»­è´¹ï¼Œä½†æ˜¯æ¯ä¸ªèµ„æºåˆéƒ½å±äºä¸€ä¸ª orderï¼Œæ•…ä½¿ç”¨ä¸€ä¸ª parent order å°†æœ¬æ¬¡ç»­è´¹çš„æ‰€æœ‰èµ„æºå…³è”èµ·æ¥ï¼Œparent ä¹Ÿå­˜å‚¨ç»­è´¹æ€»é¢ã€‚
2.   req.CreateOrderã€‚ å‰ç«¯æ§åˆ¶æœ¬æ¬¡æ˜¯å¦çœŸæ­£åˆ›å»º order è®°å½•ã€‚è‹¥æŒ‡å®šä¸åˆ›å»ºï¼Œä¸€èˆ¬æ˜¯ç”¨äºè®¡ç®—æœ¬æ¬¡ç»­è´¹çš„æ€»ä»·ã€‚
3.   æŸ¥è¯¢çº¿è·¯ä»·æ ¼æ—¶ï¼Œéœ€è¦ productId & ipRegion ä¸¤ä¸ªæ•°æ®ï¼Œè¿™ä¸¤ä¸ªå€¼åœ¨ line ä¸­æœ¬èº«æ˜¯æœ‰è®°å½•çš„ã€‚ä½†æ˜¯ä¸ç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯å†æŸ¥è¯¢æ•°æ®åº“çš„åŸå› æ˜¯ï¼Œäº§å“å’Œåœ°åŒºéƒ½å¯èƒ½ä¸‹æ¶ï¼Œå¦‚æœç»­è´¹æ—¶ï¼Œäº§å“æˆ–åŒºåŸŸå·²ç»ä¸‹æ¶ï¼Œåˆ™ä¸èƒ½ç»­è´¹ã€‚
4.   å’Œæ–°å»ºè®¢å•ä¸€æ ·ã€‚è®¡ç®—å¥½ä»·æ ¼ï¼Œè®¢å•è¡¨æ–°å¢è®°å½•åï¼Œç­‰å¾…ç”¨æˆ·æ”¯ä»˜ï¼Œè®¾ç½®ä¸€ä¸ªè¶…æ—¶å–æ¶ˆè®¢å•çš„ä»»åŠ¡



## pathlive-ops-api

### æ¢ IP 

ä»£ç ï¼š `pathlive-ops-api/change-eip.go`

çº¿è·¯æ¢ ip ã€‚å¤§è‡´æµç¨‹ä¸ºï¼š

1.   è§£ç»‘åŸå…ˆçš„ EIP å’Œ uhost çš„ç»‘å®š
2.   ç”³è¯·æ–° EIP
     1.   æŸ¥è¯¢å½“å‰å¯ç”¨çš„ IP æ®µï¼ˆeip_segments è¡¨ï¼ŒæŸ¥è¯¢åŒåŒºåŸŸï¼ŒåŒçº¿è·¯ç±»å‹çš„å¯ç”¨æ®µï¼Œé»˜è®¤ä¸åŸ ip ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªï¼‰
     2.   è°ƒç”¨ ucloud api ç”³è¯· EIP
3.   ç»‘å®šæ–° EIP å’ŒåŸå…ˆçš„ uhost



### å®¢æˆ·ç«¯å®æ—¶ ping ç»“æœ

ä»£ç ï¼š`pathlive-ops-api/ping-client.go`

åŸç†ï¼šè¿æ¥åˆ°ä¸‹è½¦ç‚¹ï¼Œæ‰§è¡Œ ping å‘½ä»¤ï¼Œå¾—åˆ°è¿”å›ç»“æœ

# Tech




## linux å‘½ä»¤

### envsubst

env-substitute: å°†æ–‡ä»¶ä¸­çš„å˜é‡ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œæ›¿æ¢

```txt
Hello user $USER in $DESKTOP_SESSION. It's time to say $HELLO!
```

> export HELLO="good morning"
> envsubst < welcome.txt
> Hello user joe in Lubuntu. It's time to say good morning!



### ğŸ”²expect

https://www.cnblogs.com/saneri/p/10819348.html

https://linux.die.net/man/1/expect

expectå¸¸ç”¨å‘½ä»¤æ€»ç»“:

>   spawn               äº¤äº’ç¨‹åºå¼€å§‹åé¢è·Ÿå‘½ä»¤æˆ–è€…æŒ‡å®šç¨‹åº
>   expect              è·å–åŒ¹é…ä¿¡æ¯åŒ¹é…æˆåŠŸåˆ™æ‰§è¡Œexpectåé¢çš„ç¨‹åºåŠ¨ä½œ
>   send exp_send       ç”¨äºå‘é€æŒ‡å®šçš„å­—ç¬¦ä¸²ä¿¡æ¯
>   exp_continue        åœ¨expectä¸­å¤šæ¬¡åŒ¹é…å°±éœ€è¦ç”¨åˆ°
>   send_user           ç”¨æ¥æ‰“å°è¾“å‡º ç›¸å½“äºshellä¸­çš„echo
>   exit                é€€å‡ºexpectè„šæœ¬
>   eof                 expectæ‰§è¡Œç»“æŸ é€€å‡º
>   set                 å®šä¹‰å˜é‡
>   puts                è¾“å‡ºå˜é‡
>   set timeout         è®¾ç½®è¶…æ—¶æ—¶é—´

ä½¿ç”¨ç¤ºä¾‹ï¼š

```shell
/usr/bin/expect << EOF
spawn ssh root@${router}
expect "*password:" {send "${pass}\r"}
expect "*#" {send "./${bin} xxx\r"}
expect "*#" {send "rm -f /root/router.init\r"}
expect "*#" {send "reboot\r"}
expect eof
EOF
```

å®éªŒï¼š

1.   åˆ›å»ºéœ€è¦äº¤äº’çš„ç¨‹åº que.sh

```sh
#!/bin/bash
 
echo "Enter your name"
 
read $REPLY
 
echo "Enter your age"
 
read $REPLY
 
echo "Enter your salary"
 
read $REPLY
```

2.   ä½¿ç”¨ expect è¿›è¡Œäº¤äº’

```sh
/usr/bin/expect <<  EOF
spawn ./que.sh
expect "Enter your name\r" {send "jianxin\r"}
expect "Enter your age\r" {send "14\r"}
expect "Enter your salary\r" {send "33333\r"}
EOF
```



### ping

ping ç”¨äºç½‘ç»œè¯Šæ–­ï¼Œåˆ¤æ–­è¿é€šæ€§

åŸç†ï¼šä¸€å°è®¾å¤‡ç»™ç›®æ ‡è®¾å¤‡å‘é€ ICMP æŠ¥æ–‡ï¼Œç­‰å¾…å…¶ç›¸åº”ï¼Œå¹¶è®°å½•æ—¶é—´ã€‚æ‰€**è€—è´¹çš„æ—¶é—´å–»ç¤ºäº†è·¯å¾„é•¿åº¦**ï¼Œ**é‡å¤è¯·æ±‚å“åº”çš„ä¸€è‡´æ€§ä¹Ÿè¡¨æ˜äº†è¿æ¥çš„è´¨é‡**ã€‚ping å›ç­”äº†ä¸¤ä¸ªé—®é¢˜ï¼š **æ˜¯å¦æœ‰è¿æ¥ï¼Œè¿æ¥çš„è´¨é‡å¦‚ä½•**ã€‚

å¸¸ç”¨é€‰é¡¹ï¼š

```text
-c count è®¾ç½®å‘é€æŠ¥æ–‡çš„æ•°é‡ï¼ŒUnix ç³»ç»Ÿä¸æŒ‡å®šåˆ™ä¼šä¸€ç›´å‘ï¼Œwindwows é»˜è®¤å‘å››æ¬¡
-i wait è®¾ç½®ä¸¤æ¬¡å‘é€ä¹‹é—´é—´éš”çš„ç§’æ•°ã€‚é»˜è®¤æ˜¯ 1s
-n è¾“å‡ºæ•°å­—å½¢å¼
```

### telnet

ç®€åŒ–ç‰ˆçš„ sshã€‚ä¹Ÿå¯ç”¨äºè¿æ¥è¿œç¨‹æœºå™¨ã€‚å’Œ ping ç›¸æ¯”ï¼Œtelnet å¯ä»¥æ¢æµ‹æœºå™¨ä¸Šçš„ç«¯å£æ˜¯å¦å¯ç”¨

### nmap

æ‰«ææœºå™¨ä¸Šå¼€æ”¾çš„ç«¯å£æœºå™¨è¢«å“ªä¸ªç¨‹åºå ç”¨

æ‰§è¡Œåå¯ä»¥å‘ç°ã€‚echo -> 7; ftp -> 21; ssh -> 22; telnet -> 23; smtp -> 25; http -> 80 â€¦â€¦

### traceroute

å±•ç°åˆ°æŸä¸ªç½‘ç»œèŠ‚ç‚¹éœ€è¦ç»è¿‡çš„ä¸­é—´èŠ‚ç‚¹ä»¥åŠå…¶è¿æ¥æƒ…å†µ

åŸç†æ˜¯é€šè¿‡ç»™åˆ°è¾¾ç›®æ ‡ä¸»æœºä¸­é—´çš„æ‰€æœ‰èŠ‚ç‚¹å‘é€ ICMP è¯·æ±‚ï¼Œå¹¶è®¡æ—¶ã€‚

å‘½ä»¤æ ¼å¼ï¼š `traceroute [options] host/ip packetSize`

### Systemd

https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html

```shell
systemctl start/stop/restart/status <service>
```

é…ç½®æ–‡ä»¶ä½ç½®ï¼š

1.   ç³»ç»Ÿè‡ªå¯åŠ¨æ—¶è°ƒç”¨ï¼š /etc/systemd/system
2.   è‡ªå®šä¹‰ï¼š/usr/lib/systemd/system



### ifconfig

https://www.computerhope.com/unix/uifconfi.htm

ifconfig -> interface onfig ç”¨æ¥æŸ¥çœ‹å’Œæ“ä½œç½‘ç»œé…ç½®çš„

ä¸å¸¦å‚æ•°ï¼Œç›´æ¥æ‰§è¡Œï¼Œå¯ä»¥æŸ¥çœ‹æœ¬æœºæ‰€æœ‰ç½‘ç»œæ¥å£çš„æƒ…å†µ

```shell
# æŸ¥çœ‹æŸä¸ªç½‘å£çš„ä¿¡æ¯
ifconfig <interface name>
```

è®¾ç½®ç½‘ç»œæ¥å£ï¼š

```shell
# åŒæ—¶é…ç½® ip åœ°å€ï¼Œå­ç½‘æ©ç ï¼Œå¹¿æ’­åœ°å€
sudo ifconfig <interface name> <ip> netmask <mask> broadcast <broadcast>
```

**ifconfig åªèƒ½åˆ†é…é™æ€ IPï¼Œ åŠ¨æ€ IP éœ€è¦ä½¿ç”¨ DHCP **



åœ°å€æ—è¯´æ˜ï¼š

-   inet: tcp/ip, ä¹Ÿå« ipv4
-   inet6: ipv6

### sed

```shell
# æ–‡æœ¬ã€æ–‡ä»¶æ›¿æ¢

# å°† log.txt æ–‡ä»¶ä¸­çš„ A éƒ½æ›¿æ¢æˆ B, å¿½ç•¥å¤§å°å†™ã€‚å¹¶å°†ç»“æœå†™å› log.txt
# ä¸å¸¦ -i åˆ™å°†æ›¿æ¢ç»“æœè¾“å‡º
# -e æ”¯æŒå¤šä¸ªï¼Œæ ‡è¯†æ›¿æ¢çš„æ­£åˆ™   -e '' -e ''
# -e åé¢çš„å­—ç¬¦ä¸²æ ¼å¼ 's/pattern/replacement/flags'
sed -i -e 's/A/B/i' log.txt
```



## go-zero

https://go-zero.dev/cn/docs/goctl/goctl

### goctl

[æŒ‡ä»¤å¤§å…¨](https://go-zero.dev/cn/docs/goctl/commands)

ä»£ç ç”Ÿæˆå·¥å…·

- api æœåŠ¡ç”Ÿæˆ
- rpc æœåŠ¡ç”Ÿæˆ
- model ä»£ç ç”Ÿæˆ
- æ¨¡æ¿ç”Ÿæˆ

#### å®‰è£…æ–¹å¼

ä½¿ç”¨æ­¤å‘½ä»¤å°† goctl å®‰è£…åˆ° `$GOPATH/bin` ä¸‹ï¼Œæ‰‹åŠ¨å°†æ­¤è·¯å¾„åŠ å…¥ç¯å¢ƒå˜é‡
```shell
GOPROXY=https://goproxy.cn/,direct go install github.com/zeromicro/go-zero/tools/goctl@latest 
```



#### api æ–‡ä»¶ç¼–å†™

[api æ–‡ä»¶è¯­æ³•](https://github.com/zeromicro/zero-doc/blob/main/go-zero.dev/cn/api-grammar.md)

##### 1. type å£°æ˜è¯·æ±‚ä¸å“åº”ç»“æ„ä½“

```api
type StuUpdateReq {
  // json çš„å‚æ•°ä»¥è¯·æ±‚ä½“çš„æ–¹å¼ä¼ å…¥
	Name string `json:"Name"`
	// form çš„å‚æ•°ï¼Œpost æ—¶æ˜¯ä¸€ä¸ª form, get æ—¶æ˜¯ url å‚æ•°çš„å½¢å¼
	Age int     `form:"Age"`
	// è¯¥å‚æ•°ä»¥ path çš„æ–¹å¼ä¼ å…¥
	Id int      `path:"Id"`
	// header çš„å‚æ•°ä»¥è¯·æ±‚å¤´çš„æ–¹å¼ä¼ å…¥
	UserId string  `header:"UserId"`
}

type StuUpdateResp {
  BaseResponse
  Ret bool `json:"Ret"`
}
```

##### 2. server å£°æ˜åŸºç¡€ä¿¡æ¯

```api
@server (
	// è·¯ç”±åˆ†ç»„
	perfix: app/v1/stu
	// åŠ è½½ä¸­é—´ä»¶, å¯¹åº”çš„ä¸­é—´ä»¶ç»“æ„ä½“åç§°ä¸º CustomJwtMiddlewareï¼Œæ­¤å¤„å¯ä»¥çœç•¥ Middleware åç¼€
	middleware: CustomJwt
)
```

##### 3. service å£°æ˜å…·ä½“çš„è·¯ç”±å®šä¹‰

```api
service stu-api {
	// æŒ‡å®š handler, å¯¹åº” handler å‡½æ•°çš„åç§°ä¸º stuUpdateHandlerï¼ˆåŒæ ·æ˜¯çœç•¥ Handler åç¼€ï¼‰
	@handler stuUpdate
	// å®šä¹‰æ­¤è·¯ç”±çš„ç›¸å…³ä¿¡æ¯ï¼šè¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚ path, å…¥å‚ä¸è¿”å›å€¼
	post /update (StuUpdateReq) returns(StuUpdateResp)
}
```



>   æ–°å¢æ—¶ï¼Œä¿®æ”¹ api æ–‡ä»¶åï¼Œå†æ¬¡è¿è¡Œ goctl ç”Ÿæˆå‘½ä»¤å³å¯å¢é‡å¼ç”Ÿæˆæ–°å¢çš„ä»£ç 

#### api æœåŠ¡ç”Ÿæˆ

å¤§è‡´æ­¥éª¤ï¼š


1. ç¼–å†™ xx.api æ–‡ä»¶
2. è¿è¡Œ `goctl api go -api xx.api -dir . -style gozero` è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ç›®å½•ã€‚å…·ä½“å‘½ä»¤ä½¿ç”¨æ–¹å¼å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://go-zero.dev/cn/docs/goctl/api)
3. è¿è¡Œ `go mod tidy` è‡ªåŠ¨å¯»æ‰¾ä¾èµ–ï¼Œå†™åˆ° go.mod ä¸­ï¼Œå¹¶è¿›è¡Œä¾èµ–ä¸‹è½½
4. ç¼–å†™å…·ä½“çš„é€»è¾‘

æˆ–è€…ç›´æ¥ä½¿ç”¨ç›´æ¥ç”Ÿæˆé¡¹ç›®ç»“æ„å’ŒåŸºæœ¬ä»£ç ï¼š

```shell
goctl api new <service name>
```



#### rpc æœåŠ¡ç”Ÿæˆ



#### model ç”Ÿæˆ

https://go-zero.dev/cn/docs/goctl/model

æ”¯æŒé€šè¿‡ MySQL ddl ç”Ÿæˆä»£ç ï¼š

```shell
goctl model mysql ddl -src="<path to ddl.sql>" -dir="<path for model code>" -c
```

é€šè¿‡ datasource ç”Ÿæˆï¼š

```shell
goctl model mysql datasource -url="user:password@tcp(127.0.0.1:3306)/database" -table="*" -dir="./model"
```

è‡ªåŠ¨ç”ŸæˆåŸºæœ¬ CRUD ä»£ç ç»“æ„ã€‚



#### å…¶ä»–æœåŠ¡ç”Ÿæˆ

https://go-zero.dev/cn/docs/goctl/other

-   docker file `goctl docker`
-   Kubenetes éƒ¨ç½²æ–‡ä»¶ `goctl kube`



### config

åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

1.   `rest.RestConf`: ä¸»è¦åŒ…å« restful api ç›¸å…³çš„é…ç½®ï¼Œå…·ä½“å†…å®¹å¯å‚è€ƒè¯¥ç»“æ„ä½“
2.   `zrpc.RpcConf`: ä¸»è¦åŒ…å« rpc ç›¸å…³çš„é…ç½®ï¼Œå…·ä½“å†…å®¹å¯å‚è€ƒè¯¥ç»“æ„ä½“





## gRPC



### Protobuf æ–‡ä»¶æ ¼å¼

https://protobuf.dev/programming-guides/proto3/

#### message

å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ä¼ é€’çš„å®ä½“

```protobuf
message BaseResp {
  string requestId = 1;
  int32 code = 2;
  string message = 3;
}

message StuUpdateReq {
  string name = 1;
  int32 age = 2;
  int32 id = 3;
  string userId = 4;
}

message StuUpdateResp {
  BaseResp baseResp = 1;
  bool ret = 2;
}
```

Message ä¸­åŒ…å«çš„é‡ç‚¹ï¼š

1.   ç±»å‹ï¼šå¯ä»¥æ˜¯ç®€å•çš„ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤æ‚ç±»å‹
2.   å­—æ®µå”¯ä¸€ç ï¼ˆField Numbersï¼‰ï¼š**ä¸€æ—¦è¿™ä¸ª message è¢«ä½¿ç”¨ï¼Œå”¯ä¸€ç å°±ä¸åº”è¯¥å†æ›´æ”¹ã€‚1-15 ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ï¼ŒåŒ…å«å¸¸ç”¨çš„å­—æ®µï¼Œ15 å¼€å¤–çš„ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚å­˜å‚¨ã€‚ä¸€èˆ¬éœ€è¦åœ¨ 15 ä»¥å†…ä¿ç•™ä¸€äº›ç©ºé—´ç”¨äºå¢åŠ ã€‚æœ€å°å€¼æ˜¯ 1ã€‚**åºåˆ—å·å®šä¹‰å¯ä»¥é‡‡ç”¨ `10, 20, 30` è¿™æ ·å¸¦é—´éš”çš„ï¼Œæ–¹ä¾¿åç»­å¢åŠ ã€‚
3.   å­—æ®µä¿®é¥°ç¬¦ï¼š
     1.   `singular`: é»˜è®¤ä¿®é¥°ç¬¦ï¼Œè¡¨ç¤ºæ¯ä¸ªå­—æ®µåªèƒ½å­˜åœ¨ 0 ä¸ªæˆ– 1 ä¸ªã€‚
     2.   `optional`: æŒ‡å®šä¸€ä¸ªå­—æ®µæ˜¯å¦æ˜¯å¿…é¡»çš„ã€‚æœªè®¾ç½®å€¼æ—¶ï¼Œä¸ä¼šè¢«åºåˆ—åŒ–ï¼›è®¾ç½®äº†å€¼æ—¶ï¼Œå¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–
     3.   `repeated`: è¡¨ç¤ºè¿™ä¸ªå­—æ®µå¯ä»¥å‡ºç°ä¸€æ¬¡æˆ–è€…å¤šæ¬¡ï¼Œä¼šä¿ç•™å…¶åŸæœ¬çš„é¡ºåºã€‚ä¸€èˆ¬ç”¨æ¥å®šä¹‰æ•°ç»„ã€‚`repeated string ids = 1;` è¡¨ç¤º ids æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚
     4.   `map`: è¡¨ç¤ºä¸€ä¸ª map ç»“æ„ 

#### service

æ ¼å¼ï¼š

```protobuf
service Rpc {
  rpc Ping(Request) returns(Response);
  rpc UpdateStu(StuUpdateReq) returns(StuUpdateResp);
}
```



## è®¡ç®—æœºç½‘ç»œ



### å­ç½‘æ©ç 

å‚è€ƒï¼š https://www.bookstack.cn/read/network-basic/7.md

å­ç½‘æ©ç çš„è¡¨ç¤ºï¼š 154.71.150.42/22 è¡¨ç¤º 154.71.150.42 è¿™ä¸ª IP çš„å­ç½‘æ©ç æ˜¯ 255.255.252.0ã€‚è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š

22 è¡¨ç¤º 32 ä½çš„å­ç½‘æ©ç ä¸­ï¼Œå‰ 22 ä½éƒ½æ˜¯ 1, å 10 ä½æ˜¯ 0ï¼Œ å³ `11111111 11111111 11111100 00000000`ï¼Œè¿™æ ·è½¬æˆåè¿›åˆ¶çš„å°±æ˜¯ `255.255.252.0`

å‰ 22 ä½éƒ½æ˜¯ 1 ï¼Œè¡¨ç¤ºè¿™äº›ä½è¢«**æ©ç›–**äº†ï¼Œä¸èƒ½ç”¨äºè¡¨ç¤ºè¯¥å­ç½‘ä¸‹çš„ä¸»æœºï¼Œå³å‰©ä¸‹èƒ½è¡¨ç¤ºä¸»æœºçš„ä½åªå‰© 10 ä½ï¼Œå°±æ˜¯è¯´ï¼Œè¿™ä¸ªå­ç½‘çš„è¿™ä¸ª ID ä¸‹èƒ½è¡¨ç¤ºçš„ä¸»æœºæ•°æ˜¯ $2^{10} = 1024$ , æ˜¯è¿™ä¸ªå­ç½‘æ®µä¸‹ä¸»æœºæ•°æœ€å¤šçš„å­ç½‘ã€‚

å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ª B ç±»ç½‘ç»œï¼Œå‰ 16 ä½è¡¨ç¤ºç½‘ç»œå·ï¼Œ22 - 16 = 6 ä½è¡¨ç¤ºå­ç½‘ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª B ç±»ç½‘ç»œä¸‹ï¼Œèƒ½æœ‰çš„å­ç½‘æ®µæ•°é‡æ˜¯ $2^6 = 64$ ä¸ªï¼Œæ€»å…±èƒ½å®¹çº³çš„ä¸»æœºæ•°ï¼š $\Sigma^{i}_{1 \le i \le 6}{2^i * 2^{16-i}}$

`154.71.150.42` è¿™ä¸ª IP å¯¹åº”çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š `10011010 1000111 100101/10 101010`ï¼Œ å› ä¸ºå…¶å­ç½‘æ©ç ä¸º 22, å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ª B ç±»ç½‘ç»œï¼Œåˆ™å…¶å‰ 16 ï¼ˆ$\lfloor22 / 8\rfloor * 8 = 16$ï¼‰ä½æ˜¯ä¸åŠ¨çš„ï¼Œå¹¶ä¸”å…¶å­ç½‘æ®µæ€»å…±æœ‰ 6 ($22 \% 8 = 6$) ä½



### NAT

Network Address Translation



SNAT Source Network Address Translation https://www.juniper.net/documentation/en_US/contrail20/topics/task/configuration/snat-vnc.html

## Kubernetes å®è·µ



### ä½¿ç”¨ cloud-native-sandbox åœ¨æœ¬åœ°è¿è¡Œ

å®‰è£… https://github.com/rootsongjc/cloud-native-sandbox.git 

ä¸‹è½½ä»“åº“ä»£ç ï¼Œå‚è€ƒä»¥ä¸‹ä»£ç è¿›è¡Œæ“ä½œï¼š https://github.com/rootsongjc/cloud-native-sandbox


### ä½¿ç”¨ minikube åœ¨æœ¬åœ°è¿è¡Œ

ä½¿ç”¨ Minikube åœ¨æœ¬åœ°è¿è¡Œ kubernetes å•æœºç‰ˆã€‚[å®‰è£…æ–¹å¼](https://minikube.sigs.k8s.io/docs/start/) 

é€šè¿‡ minikube å¯åŠ¨ k8s

`minikube start` ä¼šè‡ªåŠ¨å®‰è£… k8sï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ kubectl è¿›è¡Œæ§åˆ¶

`kubectl cluster-info` å‘½ä»¤å¯ä»¥çœ‹åˆ°å½“å‰é€šè¿‡ minikube å¯åŠ¨çš„ k8s é›†ç¾¤

`kubectl get po -A` å±•ç¤ºå½“å‰é›†ç¾¤ä¸Šçš„ pod

`minikube dashboard` å¯åŠ¨ k8s æ§åˆ¶é¢ UI



### kubectl å¸¸ç”¨å‘½ä»¤

https://cloud.tencent.com/developer/article/1638810

kubectl å¸¸ç”¨é€‰é¡¹

>   -   `kubectl options` å±•ç¤ºæ‰€æœ‰é€‰é¡¹
>   -   æ­¤å¤„çš„é€‰é¡¹ï¼Œå¯ä»¥ä¼ ç»™ä»»æ„å­å‘½ä»¤

-   -n, --namespace=''ã€‚è®¾ç½®æœ¬æ¬¡ cli å‘½ä»¤è¯·æ±‚çš„ namespace

#### get è·å–èµ„æºä¿¡æ¯

-   -o, --output æŒ‡å®šè¾“å‡ºæ ¼å¼ã€‚json,yaml, wideâ€¦â€¦

-   -l: selector label selector, =, ==, !=

-   --sort-by='': æŒ‰æŒ‡å®šå­—æ®µæ’åºï¼Œå­—æ®µå¯ä»¥é€šè¿‡æŒ‡å®šè¾“å‡ºä¸º json æ¥çœ‹ã€‚æ ¼å¼ä¸ºï¼š `--sort-by='{.status.podIP}'` æŒ‰ pod çš„ IP æ’åº

-   -A, --all-namespace=false. å¦‚æœæŒ‡å®šï¼Œè¡¨ç¤ºåˆ—å‡ºæ‰€æœ‰ namespace ä¸‹çš„èµ„æºï¼Œä¸æŒ‡å®šï¼Œåˆ™åªåˆ—å‡ºå½“å‰ namespace ä¸‹çš„

```she
kubectl get pods -o wide --sort-by='{.status.podIP}'
```

**å¸¸ç”¨èµ„æºç±»å‹åˆ—è¡¨**

`kubectl api-resources` å¯åˆ—å‡ºæ‰€æœ‰èµ„æºç±»å‹

-   namespace, ns
-   nodes, no
-   presistenctVolumes, pv
-   pods, po
-   replicationControllers, rc
-   Services, svc
-   daemonSets, ds
-   replicaSets, rs
-   statefulSets, sts
-   Cronjobs, cj
-   Events, ev

##### pod

-n: namespace æŒ‡å®š namespace



### å®éªŒ k8s app ç‰ˆæœ¬å›æ»š

1.   ä½¿ç”¨ go-zero æ—¶é—´ä¸€ä¸ªç®€å•çš„ echo api serverï¼Œ ç›‘å¬ 8888 ç«¯å£
2.   å°†ç¨‹åºæ‰“åŒ…æˆé•œåƒï¼Œå¹¶ä¸Šä¼  docker hubï¼ˆk8s é•œåƒéœ€è¦ä»æŸä¸ª registry ä¸­æ‹‰å–ï¼Œå¯ä»¥åœ¨æœ¬åœ°èµ·ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ push åˆ° docker.ioï¼‰
     1.   `docker buildx build -f ./app/Dockerfile -t xiawan12/docker-starter:002 . --push ` æ¨åˆ° docker.io xiawan12 è¿™ä¸ªè´¦å·ä¸‹
3.   é€šè¿‡é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ k8sã€‚`kubectl create namespace local-test`,  `kubectl apply -f test-docker.yml`
4.   `minikube node list` æŸ¥çœ‹å½“å‰é›†ç¾¤çš„ ip <hostIP> (`kubectl -n local-test describe pods` Node)
5.   æµè§ˆå™¨è®¿é—®ï¼š `http://<hostIp>:30004/from/me` (æ ¹æ®å…·ä½“ api server æ¥å£è°ƒæ•´)
6.   è°ƒæ•´ç‰ˆæœ¬ï¼š 
     1.   edit deployment: `kubectl -n local-test edit deployment -f test-docker.yml`ã€‚ä¿®æ”¹ image åˆ°å¯¹åº”çš„ç‰ˆæœ¬ã€‚ä¿å­˜åè‡ªåŠ¨ç”Ÿæ•ˆ
     2.   set image: `kubectl set image deployment/test-docker test-docker=xiawan12/docker-starter:001 -n local-test ` æ‰§è¡Œåè‡ªåŠ¨ç”Ÿæ•ˆ
     3.   Rollout:
          1.   æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬ï¼š`kubectl -n local-test rollout history deployment test-docker`
          2.   å›æ»šè‡³ä¸Šä¸€ç‰ˆæœ¬ï¼š`kubectl -n local-test rollout undo deployment test-docker ` **ä¼˜ç‚¹ï¼šå¯åœ¨å¾ˆç´§æ€¥ï¼Œå¹¶ä¸”æ˜ç¡®å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬å°±å¯ä»¥è§£å†³é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œç«‹å³æ¢å¤æœåŠ¡ï¼Œè€Œä¸ç”¨ç®¡å…·ä½“å“ªä¸ªç‰ˆæœ¬**
          3.   å›æ»šè‡³æŒ‡å®šç‰ˆæœ¬ï¼š `kubectl -n local-test rollout undo deployment test-docker --to-revision=<>` **ç¼ºç‚¹ï¼šéœ€è¦æ˜ç¡®çŸ¥é“æ¯ä¸ªç‰ˆæœ¬å·ä»£è¡¨çš„åŠŸèƒ½**
7.   éªŒè¯ç‰ˆæœ¬åŠŸèƒ½
8.   åœæ­¢ `kubectl -n local-test delete deployment/test-docker`

test-docker.yml å†…å®¹

```xml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-docker
  namespace: local-test
  labels:
    app: test-docker
spec:
  replicas: 2
  selector:
    matchLabels:
      app: test-docker
  template:
    metadata:
      labels:
        app: test-docker
    spec:
      containers:
      - name: test-docker
        image: xiawan12/docker-starter:001
        ports:
        - containerPort: 8888

        resources:
          limits:
            cpu: 2
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 256Mi
        
---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: test-docker
  name: test-docker
  namespace: local-test
spec:
  type: NodePort
  ports:
  - name: http
    port: 8888
    protocol: TCP
    targetPort: 8888
    nodePort: 30004
  selector:
    app: test-docker
```



## Docker cheatsheet

https://www.runoob.com/docker/docker-command-manual.html

```sh
# list images
docker images

# run an image
docker run ...
# ä»¥è¿è¡Œ mysql ä¸ºä¾‹
docker run -itd --name mysql-local -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql
# i interactive
# t tty
# d detach run in background
# --privileged ç»™å®¹å™¨å†…çš„ç¨‹åºæå‡æ‰§è¡Œæƒé™
# --rm å®¹å™¨åœæ­¢æ—¶åˆ é™¤
# --restart=always å®¹å™¨å¯åŠ¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯ï¼Œä¹Ÿå¯ä»¥è®¾ç½®é‡å¯æ¬¡æ•°


# redis
docker run -itd --name redis-local -p 6379:6379 redis

# with env 
docker run -e k=v <name>

# æŸ¥çœ‹å½“å‰è¿è¡Œå®¹å™¨çš„çŠ¶æ€
docker stats
```

#### image

```sh
# æŸ¥æ‰¾é•œåƒ
docker search <image name>

# æ‹‰å–é•œåƒ
docker pull <image name>:<version|lastest> (ä¸å¸¦ç‰ˆæœ¬ï¼Œé»˜è®¤æ‹‰å–æœ€æ–°çš„)

# åˆ—å‡ºå®‰è£…çš„æ‰€æœ‰é•œåƒ
docker images

# åˆ é™¤é•œåƒ
docker rmi <image name>

docker tag source_image[:tag] target_image[:tag]

docker push <hub server>
```

#### container

```sh
docker container -h

docker container attach <id>

# åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œ
docker exec -it <id> <cmd>

# æŸ¥çœ‹å®¹å™¨ä¿¡æ¯
docker container inspect <id>

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps -a

# å¯åŠ¨ä¸€ä¸ªåœæ­¢çš„å®¹å™¨ cid: å®¹å™¨ id
docker start <cid>

# æŸ¥çœ‹å®¹å™¨çš„æ—¥å¿—  docker logs --help
docker logs -f <cid>

# æŸ¥çœ‹å®¹å™¨çš„ç«¯å£æ˜ å°„
docker port <cid>

# æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹æƒ…å†µ
docker top <cid>
```

#### ğŸ”²Dockerfile

https://www.runoob.com/docker/docker-dockerfile.html



https://yeasy.gitbook.io/docker_practice/  ä»¥ä¸‹å†…å®¹ä¸»è¦å‚è€ƒè¯¥æ–‡æ¡£

#### ç®¡ç†æ•°æ®

docker ä¸­çš„æ•°æ®ç®¡ç†ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

1.   æ•°æ®å·ï¼ˆvolumesï¼‰
2.   æŒ‚è½½ä¸»æœºç›®å½•ï¼ˆbind mountsï¼‰

##### æ•°æ®å·

æ•°æ®å·æ˜¯å’Œå®¹å™¨åˆ†å¼€çš„ï¼Œå¯ä»¥ç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå¯ä»¥æŒ‚è½½åˆ°å¤šä¸ªå®¹å™¨ä¸Šã€‚

```shell
# åˆ›å»ºæ•°æ®å·
docker volume create my-volumn
# æŸ¥çœ‹æ‰€æœ‰æ•°æ®å·
docker volume ls
# æŸ¥çœ‹æŒ‡å®šæ•°æ®å·ä¿¡æ¯
docker volume inspect <volume_name>
# ç»™å®¹å™¨æŒ‡å®šæ•°æ®å·ã€‚ä½¿ç”¨ --mount æ¥å°†æ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨é‡Œ(å¯ä¸€æ¬¡æŒ‚è½½å¤šä¸ª)
docker run -d --name web --mount source=my-volume,target=/usr/share/nginx/html nginx:alpine

# åˆ é™¤ï¼ˆvolume ç‹¬ç«‹äºå®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œå®¹å™¨åˆ é™¤ä¸ä¼šåˆ é™¤ volumeï¼ˆé™¤é docker rm -vï¼‰, æœªè¢«å¼•ç”¨çš„ volume ä¹Ÿä¸ä¼šä¸»åŠ¨åˆ é™¤ï¼‰
docker volume rm my-volume
# æ¸…ç†æ— ç”¨çš„ volume æ¥ç²¾ç®€ç©ºé—´
docker volume prune
```

##### æŒ‚è½½ä¸»æœºç›®å½•

å°±æ˜¯å°†ä¸»æœºçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œï¼Œä½¿ç”¨æ–¹å¼ï¼š`--mount type=bind,source=<host absolute path>,target=<container path>[,readonly]`

ä¸€èˆ¬ç”¨æ¥æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡æ“ä½œæœ¬åœ°æ–‡ä»¶æ¥è¾¾åˆ°æ“ä½œå®¹å™¨ä¸­æ–‡ä»¶çš„ç›®çš„ã€‚æµ‹è¯•æ¯”è¾ƒæ–¹ä¾¿ã€‚ä¸€ä¸ªåœºæ™¯æ˜¯ï¼Œå¦‚æœå®¹å™¨å†…çš„ app å¯ä»¥å®æ—¶è¯»å–é…ç½®æ–‡ä»¶çš„å†…å®¹çš„å˜æ›´ï¼Œåˆ™å¯ä»¥æŠŠä¸»æœºä¸Šè¿™ä¸ªæ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œï¼Œé€šè¿‡åœ¨ä¸»æœºä¸Šè°ƒæ•´é…ç½®æ–‡ä»¶

#### ä½¿ç”¨ç½‘ç»œ

å®¹å™¨ä½¿ç”¨ç½‘ç»œä¸»è¦æ˜¯ä¸¤ç§æ–¹å¼ï¼š

1.   å¤–éƒ¨è®¿é—®å®¹å™¨
2.   å®¹å™¨äº’è”

##### å¤–éƒ¨è®¿é—®å®¹å™¨

è¯¥ç§æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡è®¾å®š**ç«¯å£æ˜ å°„**æ¥å®ç°å®¹å™¨å†…éƒ¨çš„ç½‘ç»œåº”ç”¨è®¿é—®ç½‘ç»œã€‚å¯ä»¥é€šè¿‡ 1. `-P` éšæœºåˆ†é…ç«¯å£æ˜ å°„ 2. `-p <host port>:<container port>` æ¥æŒ‡å®šå®¹å™¨å’Œä¸»æœºçš„ç«¯å£æ˜ å°„ã€‚

å¦‚ï¼š`docker run -d --name nginx -p 80:80 nginx:alpine` å¯ä»¥å°† NGINX è¿è¡Œåœ¨å®¹å™¨å†…ï¼Œå¹¶é€šè¿‡ä¸»æœºçš„ 80 ç«¯å£è®¿é—®ã€‚

`-p` çš„ä¸€èˆ¬æ ¼å¼ï¼š

1.   `ip:hostPort:containerPort`ã€‚æ˜ å°„æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£åˆ°å®¹å™¨çš„ç«¯å£ã€‚å¦‚ `127.0.0.1:80:80` æ˜ å°„ 127.0.0.1 çš„ 80 ç«¯å£åˆ°å®¹å™¨çš„ 80 ç«¯å£
2.   `ip::containerPort`ã€‚æ˜ å°„æŒ‡å®šåœ°å€çš„æ‰€æœ‰ç«¯å£åˆ°å®¹å™¨çš„ç«¯å£
3.   `hostPort:containerPort`ã€‚æ˜ å°„æœ¬åœ°æ‰€æœ‰æ¥å£çš„ç«¯å£åˆ°å®¹å™¨çš„ç«¯å£ï¼ˆ**å¸¸ç”¨**ï¼‰

`-p` å¯ä»¥ä½¿ç”¨å¤šæ¬¡æ¥æ˜ å°„å¤šä¸ªç«¯å£

##### å®¹å™¨äº’è”

è¦å®ç°å®¹å™¨ä¹‹é—´ç½‘ç»œäº’è”ï¼Œä¸€èˆ¬ä¼šåœ¨ run çš„æ—¶å€™é€šè¿‡ `--link` æ¥é“¾æ¥å®¹å™¨ã€‚

```shell
docker run -itd --name cc --link c1
```

ä½†æ›´å¥½çš„åšæ³•æ˜¯å°†ç½‘ç»œç‹¬ç«‹å‡ºæ¥ã€‚ä½¿ç”¨ `docker network create` åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼Œåœ¨å°†éœ€è¦äº’è”çš„å®¹å™¨éƒ½å…³è”åˆ°åŒä¸€ä¸ªç½‘ç»œå³å¯

```shell
# create network
docker network create ap_net

# å¯åŠ¨ä¸¤ä¸ªå®¹å™¨
docker run -itd --name ap0 alpine ash
docker run -itd --name ap1 alpine ash

# åœ¨å®¹å™¨é‡Œ ping å¦ä¸€ä¸ªå®¹å™¨ï¼Œä¼šå‘ç°ç½‘ç»œä¸é€š
ping ap1

# å°† ap0 ap1 åŠ å…¥ç½‘ç»œ ap_net
docker network connect ap_net ap0
docker network connect ap_net ap1

# å†æ¬¡ ping å‘ç°å¯ä»¥ ping é€š
```

```shell
docker network --help
Usage:  docker network COMMAND

Manage networks

Commands:
  connect     Connect a container to a network
  create      Create a network
  disconnect  Disconnect a container from a network
  inspect     Display detailed information on one or more networks
  ls          List networks
  prune       Remove all unused networks
  rm          Remove one or more networks
```

ä½¿ç”¨ `docker network inspect <network>` å¯ä»¥æŸ¥çœ‹è¿™ä¸ªç½‘ç»œçš„è¯¦æƒ…ï¼ŒåŒ…æ‹¬æœ‰å“ªäº›å®¹å™¨åœ¨ä½¿ç”¨è¿™ä¸ªç½‘ç»œã€‚

(å®é™…ä¸Šï¼Œæœ€ç»ˆè¿˜æ˜¯é€šè¿‡å®¿ä¸»æœºçš„ **iptables** æ¥æ§åˆ¶å®¹å™¨é—´çš„ç½‘ç»œ)



## Docker Compose

`docker compose [command]`

æ”¯æŒåŒæ—¶è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚ä½¿ç”¨ `docker-compose.yaml` æ–‡ä»¶å®šä¹‰é¡¹ç›®ä»¥åŠæœåŠ¡ã€‚

æ¦‚å¿µï¼š

-   æœåŠ¡ï¼šå®é™…è¿è¡Œçš„å®¹å™¨
-   é¡¹ç›®ï¼šå¤šä¸ªæœåŠ¡ç»„æˆã€‚åœ¨ docker-compose.yaml æ–‡ä»¶ä¸­å£°æ˜



### å®éªŒ

1.   åˆ›å»ºä¸€ä¸ªå¯ä»¥æŒç»­è¿è¡Œä¸€æ®µæ—¶é—´çš„è„šæœ¬
2.   ä½¿ç”¨ Dockerfile å°†è¿™ä¸ªè„šæœ¬åšæˆä¸€ä¸ªé•œåƒ
3.   ä½¿ç”¨ Docker Componse å°†è¿™ä¸ªé•œåƒè¿è¡Œæˆå¤šä¸ªæœåŠ¡ï¼Œå¹¶è‡ªåŠ¨æ‰©ç¼©å®¹



#### æŒç»­è¿è¡Œçš„è„šæœ¬

WORKDIR: ./docker

```shell
#!/bin/ash

echo 'hhhhh'

# æš‚åœï¼Œä¾¿äºåé¢çš„æ“ä½œ
sleep 600

echo 'container done'
```

#### å°†è„šæœ¬åšæˆé•œåƒ

WORKDIR: ./docker

```dockerfile
FROM alpine:3.16

ENV NAME=hello AGE=11

WORKDIR /app

COPY /app.sh .

RUN chmod +x app.sh

ENTRYPOINT [ "/app/app.sh" ]
```

â”œâ”€â”€ docker
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ app.sh
â”œâ”€â”€ docker-compose.yaml

#### Compose It

```yaml
version: "3"

services:
  ap1:
    build: ./docker
    networks: 
        - ap_net

  ap2:
    build: ./docker
    networks: 
        - ap_net
    depends_on:
    		- ap1

networks:
  ap_net:
```

#### Run

```shell
# start all service
$ docker compose up -d
[+] Running 3/3
 âœ” Network docker-starter_ap_net   Created
 âœ” Container docker-starter-ap1-1  Started
 âœ” Container docker-starter-ap2-1  Started
 
$ docker container ls -a
CONTAINER ID   IMAGE              COMMAND       CREATED          STATUS       PORTS     NAMES
f8e29fb8becd   docker-starter-ap2 "/app/app.sh" 6 seconds ago    Up 5 seconds           docker-starter-ap2-1
2ff6891de6ac   docker-starter-ap1 "/app/app.sh" 6 seconds ago    Up 5 seconds           docker-starter-ap1-1

# scala
$ docker compose up -d --scale ap1=2
[+] Running 3/3
 âœ” Container docker-starter-ap1-1  Running
 âœ” Container docker-starter-ap2-1  Running
 âœ” Container docker-starter-ap1-2  Started
 
 $ docker container ls -a
 CONTAINER ID   IMAGE              COMMAND          CREATED        STATUS       PORTS NAMES
cfe654dcdabc   docker-starter-ap1  "/app/app.sh"    1 minute ago   Up 2 minutes       docker-starter-ap1-2
f8e29fb8becd   docker-starter-ap2  "/app/app.sh"    2 minutes ago  Up 2 minutes       docker-starter-ap2-1
2ff6891de6ac   docker-starter-ap1  "/app/app.sh"    2 minutes ago  Up 2 minutes       docker-starter-ap1-1

# scala
$ docker compose up -d --scale ap1=1
[+] Running 2/2
 âœ” Container docker-starter-ap1-1  Running
 âœ” Container docker-starter-ap2-1  Running
 
 $ docker container ls -a
CONTAINER ID   IMAGE              COMMAND       CREATED          STATUS       PORTS     NAMES
f8e29fb8becd   docker-starter-ap2 "/app/app.sh" 6 seconds ago    Up 5 seconds           docker-starter-ap2-1
2ff6891de6ac   docker-starter-ap1 "/app/app.sh" 6 seconds ago    Up 5 seconds           docker-starter-ap1-1

# test container link
$ docker exec -it docker-starter-ap1-1 sh
/app # ping docker-starter-ap2-1
PING docker-starter-ap2-1 (192.168.107.3): 56 data bytes
64 bytes from 192.168.107.3: seq=0 ttl=64 time=0.394 ms
64 bytes from 192.168.107.3: seq=1 ttl=64 time=0.179 ms
^C
--- docker-starter-ap2-1 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.179/0.286/0.394 ms
/app # 

# stop
$ docker compose down
[+] Running 3/3
 âœ” Container docker-starter-ap2-1  Removed
 âœ” Container docker-starter-ap1-1  Removed
 âœ” Network docker-starter_ap_net   Removed
```



## Docker Swarm

ç±»ä¼¼ k8s çš„é›†ç¾¤ç®¡ç†ä¸ç¼–æ’å·¥å…·ã€‚

**èŠ‚ç‚¹**ï¼šè¿è¡Œ docker çš„**å®¿ä¸»æœº**è¢«çœ‹ä½œæ˜¯ docker swarm çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚èŠ‚ç‚¹åˆ†ä¸º**ç®¡ç†èŠ‚ç‚¹**ï¼ˆmanagerï¼‰å’Œ**å·¥ä½œèŠ‚ç‚¹**ï¼ˆworkerï¼‰ã€‚docker swarm å‘½ä»¤åŸºæœ¬åªèƒ½åœ¨ç®¡ç†èŠ‚ç‚¹æ‰§è¡Œã€‚å¯ä»¥æœ‰å¤šä¸ªç®¡ç†èŠ‚ç‚¹ï¼Œä½†åªä¼šæœ‰ä¸€ä¸ª leader, é€šè¿‡ raft åè®®é€‰ä¸¾ã€‚

**æœåŠ¡å’Œä»»åŠ¡**ï¼š ä»»åŠ¡æ˜¯ swarm ä¸­æœ€å°çš„è°ƒåº¦å•ä½ï¼Œä¹Ÿå°±æ˜¯ docker çš„å®¹å™¨ã€‚æœåŠ¡æ˜¯ä¸€ç³»åˆ—ä»»åŠ¡çš„é›†åˆã€‚

å»ºè®®ç›´æ¥ä½¿ç”¨ k8sã€‚



## Kubernetes ç†è®º

ç›®æ ‡ï¼šç®¡ç†è·¨å¤šä¸ªä¸»æœºçš„å®¹å™¨ï¼Œæä¾›åŸºæœ¬çš„éƒ¨ç½²ã€ç»´æŠ¤ä»¥åŠåº”ç”¨çš„ä¼¸ç¼©ã€‚

åŸºæœ¬æ¦‚å¿µï¼šhttps://yeasy.gitbook.io/docker_practice/kubernetes/concepts

-   èŠ‚ç‚¹ Nodeï¼šæ˜¯è¿è¡Œ kubernetes çš„ä¸»æœº
    -   å¯ä»¥æ˜¯ç‰©ç†ä¸»æœºï¼Œä¹Ÿå¯ä»¥æ˜¯è™šæ‹Ÿæœºï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦è¿è¡Œä¸€äº›å¿…è¦çš„æœåŠ¡ä»¥è¿è¡Œå®¹å™¨ï¼Œå¦‚ docker, kubelet, ä»£ç†æœåŠ¡â€¦â€¦
    -   å®¹å™¨çŠ¶æ€ç”¨æ¥æè¿°èŠ‚ç‚¹å½“å‰çš„çŠ¶æ€ã€‚ä¸»è¦æœ‰ï¼šRunning, Pending, 
-   å®¹å™¨ç»„ Pod: ä¸€ä¸ª Pod æ˜¯ç”±è‹¥å¹²ä¸ªå®¹å™¨ç»„æˆçš„å®¹å™¨ç»„ï¼ŒåŒä¸ªç»„å†…çš„å®¹å™¨å…±äº«ç›¸åŒçš„å­˜å‚¨å·
-   å®¹å™¨ç»„ç”Ÿå‘½å‘¨æœŸ Pod-states: æ˜¯å®¹å™¨æ‰€æœ‰çŠ¶æ€çš„é›†åˆã€‚åŒ…æ‹¬ï¼špod ç±»å‹ï¼Œpod ç”Ÿå‘½å‘¨æœŸï¼Œäº‹ä»¶ï¼Œé‡å¯ç­–ç•¥ï¼Œreplication controllers
-   å‰¯æœ¬æ§åˆ¶å™¨ Replication controllers: è´Ÿè´£æŒ‡å®šæ•°é‡çš„ pod åœ¨åŒä¸€æ—¶é—´ä¸€èµ·è¿è¡Œ
-   æœåŠ¡ services: æ˜¯ pod çš„é«˜çº§æŠ½è±¡ï¼ŒåŒæ—¶æä¾›å¤–éƒ¨è®¿é—® pod çš„ç­–ç•¥
-   å· volumes: å°±æ˜¯ä¸€ä¸ªç›®å½•
-   æ ‡ç­¾ labels: ç”¨æ¥è¿æ¥ä¸€ç»„å¯¹è±¡ï¼Œæ¯”å¦‚ podã€‚æ ‡ç­¾å¯ä»¥ç”¨æ¥ç»„ç»‡å’Œé€‰æ‹©å­å¯¹è±¡
-   æ¥å£æƒé™: ç«¯å£ã€IPå’Œä»£ç†çš„é˜²ç«å¢™è§„åˆ™
-   web ç•Œé¢ï¼š å¯ä»¥é€šè¿‡ ui æ“æ§ kubernetes
-   cli å‘½ä»¤ï¼š Kubectl





## SSH Config

https://linuxize.com/post/using-the-ssh-config-file/



å…·ä½“å¦‚ä½•é…ç½®å¯ä»¥å‚è€ƒ `man ssh_config`



é…ç½®å¤§è‡´æ ¼å¼ï¼š

```conf
Host hostname1
	SSH_OPTION value
	SSH_OPTION value
Host hostname2
	SSH_OPTION value
	SSH_OPTION value
Host * (åŒ¹é…æ‰€æœ‰ Host)
	SSH_OPTION value
```

è¯»å–é¡ºåºæ˜¯è‡ªä¸Šè€Œä¸‹ï¼Œä¸€æ®µæ®µè¯»å–ï¼Œå…ˆè¯»å–çš„ OPTION ä¼˜å…ˆçº§æ›´é«˜ã€‚



æ‰€ä»¥å¦‚æœæœ‰ç›¸åŒçš„ Host å®šä¹‰ï¼Œå…ˆå®šä¹‰çš„ç”Ÿæ•ˆã€‚ä¸€èˆ¬åœ°ï¼Œæ›´ç²¾ç¡®çš„å®šä¹‰æ”¾åœ¨æ–‡ä»¶å¼€å¤´ï¼Œæ›´ä¸€èˆ¬æ€§çš„å®šä¹‰æ”¾åœ¨æ–‡ä»¶æœ«å°¾ã€‚



## ç¼“å­˜ & Db

å¸¦ç¼“å­˜çš„æ•°æ®åº“æ“ä½œã€‚

1.   åœ¨å†™å…¥æ—¶ï¼Œå…ˆå†™å…¥æ•°æ®åº“ï¼Œå†å†™å…¥ç¼“å­˜
2.   åœ¨åˆ é™¤æ—¶ï¼Œå…ˆåˆ é™¤æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
3.   æŸ¥è¯¢ï¼Œåˆ™æ˜¯å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œä¸ä¸­å†æŸ¥è¯¢æ•°æ®åº“

ä»¥ go-zero/cachedsql.go ä¸­çš„æ–¹æ³•ä¸ºä¾‹ï¼š

```go
// ExecCtx runs given exec on given keys, and returns execution result.
func (cc CachedConn) ExecCtx(ctx context.Context, exec ExecCtxFn, keys ...string) (
	sql.Result, error) {
  // å…ˆæ‰§è¡Œæ•°æ®åº“æ“ä½œ
	res, err := exec(ctx, cc.db)
	if err != nil {
		return nil, err
	}

  // å†æ‰§è¡Œç¼“å­˜æ“ä½œã€‚
	if err := cc.DelCacheCtx(ctx, keys...); err != nil {
		return nil, err
	}

	return res, nil
}
```

å¦‚æœé¡ºåºåäº†ï¼š

1.   å†™å…¥çš„æƒ…å†µä¸‹ã€‚å¦‚æœå†™å…¥æ•°æ®åº“å¤±è´¥ï¼Œè¿˜è¦å†å›æ»šç¼“å­˜ï¼Œå¹¶ä¸”ï¼Œå¦‚æœæœ‰çº¿ç¨‹è¯»åˆ°äº†ç¼“å­˜ï¼Œå°±ç›¸å½“äºè¯»å–åˆ°äº†ä¸€ç¬”ä¸å­˜åœ¨çš„è®°å½•
2.   åˆ é™¤æƒ…å†µä¸‹ã€‚å¦‚æœç¼“å­˜å…ˆè¢«æ¸…é™¤ï¼Œä½†è¿˜æ²¡æ¥å¾—åŠå†™æ•°æ®åº“ï¼Œæ­¤æ—¶æœ‰çº¿ç¨‹è¯»å–ï¼Œè‚¯å®šæ˜¯è¯»å–åˆ°æ•°æ®åº“ä¸­çš„æ—§è®°å½•ï¼Œä½†æ˜¯è¿™ä¸ªæ•°æ®æ˜¯å³å°†è¢«åˆ é™¤çš„ï¼Œæ‰€ä»¥ä¹Ÿå‘ç”Ÿè„è¯»



## ğŸ”²Frp

https://sspai.com/post/52523



## é€šè¿‡ CSS ç»™ HTML å…ƒç´ åŠ æ°´å°

HTML ç»“æ„ï¼š

```html
<div class="container">
    <div :class="'ad' + (i || '') + ' ad'" v-for="(ad, i) in 3">
        {{watermark}}
    </div>
    ...
</div>
```

CSS:

```scss
.container {
  // é‡è¦
  position: relative;

  --marker-right: 40%;
  --marker-top: 50%;

  .ad1 {
    --marker-right: 60%;
    --marker-top: 30%;
  }

  .ad2 {
    --marker-right: 20%;
    --marker-top: 70%;
  }

  .ad {
    font-weight: bold;
    text-align: center;
    width: 300px;
    // é‡è¦
    position: absolute;
    right: var(--marker-right);
    top: var(--marker-top);
    opacity: 0.15;
    rotate: -36deg;
    user-select: none;
    overflow: hidden;
    pointer-events: none;
  }
}
```

## Golang å¼‚æ­¥ç¡®è®¤ & è¶…æ—¶æ§åˆ¶

```go
package logic

import (
	"context"

	"github.com/zeromicro/go-zero/core/logx"
	"time"
)

type RouterRecordReq struct {
	RouterId    string
	LineId      string
	CheckUnbind bool
}

var checkInterval = 10 * time.Second
var timeOut = 18 * checkInterval

func (l *RouterAsyncLogic) RecordRouterAsync(in *RouterRecordReq) {
	go func() {
		timeOutChan := time.After(timeOut)
		doRecord := false
		for {
			time.Sleep(checkInterval)
			// è¶…æ—¶ï¼Œæˆ–è€… checkRouter è¿”å› true, å°±åœæ­¢å¾ªç¯
			done := l.keepCheckUntil(timeOutChan, func() bool {
				checked, err := l.checkRouter(in.RouterId, in.LineId, in.CheckUnbind)
				// æ‰§è¡Œå‡ºé”™æˆ–è€…è¿”å› trueï¼Œéƒ½ä¸å†å¾ªç¯
				if err != nil || checked {
					if checked {
						// è¿”å› true , åˆ™è®°å½•å†å²
						doRecord = true
					}
					return true
				}
				return false
			})
			if done {
				break
			}
		}
		op := utils.Ternary(in.CheckUnbind, "è§£ç»‘", "ç»‘å®š")
		// è®°å½•è·¯ç”±å™¨æ“ä½œå†å²ä¹‹å‰ï¼Œå…ˆç¡®å®š"ç»‘å®š/è§£ç»‘"æ“ä½œæˆåŠŸå†è®°å½•å†å²
		if doRecord {
			operationType := utils.Ternary(in.CheckUnbind,
				resourceserver.RouterOperation_UNBIND,
				resourceserver.RouterOperation_BIND)
			_, _ = NewRouterHistoryLogic(l.ctx, l.svcCtx).RouterHistory(&resourceserver.RouterHistoryRequest{
				OperationType: operationType,
				RouterId:      in.RouterId,
			})
			l.Logger.Infof("%s è·¯ç”±å™¨æ“ä½œå†å², routerId: %s", op, in.RouterId)
		} else {
			l.Logger.Errorf("%s è·¯ç”±å™¨æ“ä½œå†å²å¤±è´¥, routerId: %s", op, in.RouterId)
		}
	}()
}

func (l *RouterAsyncLogic) keepCheckUntil(timeOutChan <-chan time.Time, predictor func() bool) bool {
	select {
	case <-timeOutChan:
		return true
	case <-time.After(500 * time.Millisecond):
		return predictor()
	}
}

// checkRouter æ£€æŸ¥ router çš„çŠ¶æ€ã€‚checkUnbind è¡¨ç¤ºæ˜¯å¦æ£€æŸ¥ router çš„æœªç»‘å®šçŠ¶æ€ï¼›å¦åˆ™å°±æ£€æŸ¥ç»‘å®šçŠ¶æ€
// è¿”å› bool, è¡¨ç¤ºæ˜¯å¦æ»¡è¶³æŒ‡å®šçš„çŠ¶æ€
// åœ¨ç»‘å®šçš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå†æ¬¡è¢«ç»‘å®šæˆ–è€…è§£ç»‘ã€‚
// æš‚æ—¶åœ¨é¡µé¢æ§åˆ¶äºŒè€…å¿…é¡»é¡ºåºå‘ç”Ÿã€‚å•ä¸ªé‡å¤å‘ç”Ÿæ—¶ï¼Œå¹¶ä¸å½±å“è®°å½•æ“ä½œå†å²çš„å‡†ç¡®æ€§
func (l *RouterAsyncLogic) checkRouter(routerId, lineId string, checkUnbind bool) (bool, error) {
	router, err := l.svcCtx.PathliveRpc.GetRouter(l.ctx, &pathlive.GetRouterRequest{
		RouterId: routerId,
	})
	if err != nil {
		return false, err
	}
	r := router.Router
	if checkUnbind {
		// å½“å‰æ˜¯å¦æ˜¯è§£ç»‘çŠ¶æ€
		return r.LineInfo == nil || r.LineInfo.LineId == "", nil
	} else {
		return r.LineInfo != nil && r.LineInfo.LineId == lineId, nil
	}
}
```



## TikTok ç®€æ˜“çˆ¬è™«å®ç°

tiktok web é¡µé¢ï¼Œä¸ºå„ç§çˆ¬è™«å‡†å¤‡äº†ä¸€ä»½æ•°æ®ï¼Œå°±æ˜¯å…¶é¡µé¢æºç ä¸­ï¼Œä¸€ä¸ª id ä¸º `SIGI_STATE` çš„ script é‡Œçš„ json æ•°æ®ã€‚å®é™…ä¸Šï¼Œtiktok web é¡µé¢ä½¿ç”¨ sigi æ¡†æ¶ï¼Œå¹¶ä¸”é…åˆ SSR å°† sigi åº”ç”¨çš„ state ä¿å­˜åœ¨äº† dom é‡Œï¼Œç›¸å½“äº vue çš„ dataã€‚è¿™ä¸ª state é‡ŒåŒ…å«äº†ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œç”¨æˆ·å‘å¸ƒçš„è§†é¢‘ç­‰ç­‰ä¿¡æ¯ã€‚

æ‰€ä»¥éœ€è¦åšçš„å°±æ˜¯æ‹‰å– web é¡µé¢ï¼Œè§£æå‡ºè¿™ä¸ª json, å¹¶ä¸”è·å–æ„Ÿå…´è¶£çš„å­—æ®µã€‚

ç¬¬ä¸€æ­¥ï¼Œè®¿é—® tk é¡µé¢ã€‚tk æ˜¯é™åˆ¶äº†è®¿é—®åŒºåŸŸçš„ï¼Œæ¯”å¦‚å›½å†…ä»¥åŠæƒ³å¹²çš„å¤§éƒ¨åˆ† ip éƒ½ä¸èƒ½å¤Ÿè®¿é—®ã€‚æ‰€ä»¥ç¬¬ä¸€æ­¥å°±æ˜¯éœ€è¦æœ‰ä¸€å°èƒ½å¤Ÿè®¿é—® tk çš„æœºå™¨ã€‚

ç¬¬äºŒæ­¥ï¼Œåœ¨è¿™å°æœºå™¨ä¸Šä½¿ç”¨ curl è®¿é—® tk ä¸»é¡µ

ç¬¬ä¸‰æ­¥ï¼Œä» html é¡µé¢ä¸­è§£æå‡º json

ç¬¬å››æ­¥ï¼Œä» JSON ä¸­æå–æ„Ÿå…´è¶£çš„å­—æ®µ

### ä»£ç å®ç°

ä¸€ï¼šè·³æ¿æœºã€‚å› ä¸º tk å¯¹è®¿é—®çš„åŒºåŸŸæ•æ„Ÿï¼Œæ‰€ä»¥å‡†å¤‡äº†å¤šä¸ªåŒºåŸŸçš„å¤šå°æœºå™¨å¤‡ç”¨ã€‚æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥é€‰æ‹©å‘èµ·è®¿é—®çš„åŒºåŸŸ

```go
// region: ip
var TkDestIpMap = map[string][string]{}
```

ä½¿ç”¨ ssh å·¥å…·ï¼Œè¿æ¥åˆ°æŒ‡å®šåŒºåŸŸï¼Œå¹¶æ‰§è¡Œå‘½ä»¤ã€‚è¿™é‡Œå†™ä¸€ä¸ªç®€æ˜“çš„ ssh å·¥å…·

```go
// ç°åœ¨å¤ªèœï¼Œåé¢è¡¥
```

è¿æ¥ä¸Šä¹‹åï¼Œå°±å¯ä»¥æ‰§è¡Œå‘½ä»¤äº†ã€‚ä½†æ˜¯å› ä¸ºå‘½ä»¤æ¯”è¾ƒå¤šï¼Œè€Œä¸”ä½¿ç”¨ shell ç¼–å†™ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥ä½¿ç”¨ golang ç¼–å†™ï¼Œå†æ‰“åŒ…æˆå¯æ‰§è¡Œå‘½ä»¤ï¼Œç„¶ååªéœ€è¦è§¦å‘ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚



äºŒï¼šè·å– HTML å¹¶æå–æ„Ÿå…´è¶£çš„å­—æ®µ

ç¼–å†™ä¸€ä¸ª golang å‘½ä»¤è¡Œå·¥å…·

```go
package main

import (
	"bytes"
	"encoding/json"
	"errors"
	"flag"
	"fmt"
	"os/exec"
	"regexp"
	"strings"
)

var tkId = flag.String("t", "", "tk user id")

// ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ï¼Œå°†æ­¤ go ç¨‹åºç¼–è¯‘æˆå¯æ‰§è¡Œç¨‹åºï¼ˆè¿™é‡Œç¼–è¯‘åçš„å¯æ‰§è¡Œç¨‹åºåä¸º fetchã€‚ ä½¿ç”¨æ–¹å¼ä¸º ./fetch -t <tk user id>ï¼‰
// build: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ./fetch ./parseTkState.go
func main() {
	flag.Parse()

	sw := bytes.Buffer{}
	command := exec.Command("curl", "-s", "https://www.tiktok.com/@"+*tkId)
	command.Stdout = &sw
	err := command.Run()
	if err != nil {
		_ = fmt.Errorf("curl tk failed %v", err)
		return
	}

  // ä½¿ç”¨ curl è·å–åˆ°çš„ tk ä¸»é¡µ html
	html := sw.String()
	script, err := extraJsonInScript(html)
	if err != nil {
		_ = fmt.Errorf("extra json failed %v", err)
		return
	}
  // å°†ç»“æœè¾“å‡ºåˆ° stdoutï¼Œä¾¿äºè°ƒç”¨è€…è·å–
	fmt.Print(script)
}

// ä» html ä¸­è§£æå‡ºå«æœ‰ç”¨æˆ·ä¿¡æ¯çš„ json
var scriptsReg = regexp.MustCompile(`<script\s+.*?>(.*?)</script>`)
func extraJsonInScript(html string) (string, error) {
	ret := ""
	rets := scriptsReg.FindAllStringSubmatch(html, -1)
	for _, v := range rets {
		isStateScript := strings.Contains(v[0], `id="SIGI_STATE"`)
		if len(v) > 1 && isStateScript && json.Valid([]byte(v[1])) {
			state := TKState{}
			jsonStr := strings.Trim(v[1], " ")
			err := json.Unmarshal([]byte(jsonStr), &state)
			if err != nil {
				continue
			}
			userMap := state.UserModule.Users
			if userMap == nil || len(userMap) == 0 {
				return "", errors.New("ç”¨æˆ·ä¸å­˜åœ¨æˆ–è´¦å·å·²æ³¨é”€")
			}
			// è¿”å›ä»€ä¹ˆå†…å®¹ï¼Œç”± TKState å†³å®š
			stateStr, err := json.Marshal(state)
			if err != nil {
				continue
			}
			ret = string(stateStr)
			break
		}
	}
	return ret, nil
}

// çœç•¥è¿™ä¸ªç»“æ„ä½“çš„å†…å®¹ã€‚å…·ä½“å†…å®¹å¯ä»¥æ‰‹åŠ¨æŠŠ tk ä¸»é¡µçš„ json æ‹‰å‡ºæ¥çœ‹ï¼Œå¹¶ä¸”ä½¿ç”¨å·¥å…·è½¬æ¢æˆç»“æ„ä½“å³å¯
type TKState struct {
}
```

æœ‰äº† fetch è¿™ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè°ƒç”¨æ–¹å°±å¾ˆç®€å•äº†ã€‚

```go
sh := NewSSHHelper(sshConf)
cmd := fmt.Sprintf("./fetch -t %s", url.PathEscape(tiktokId))
Logger.Infof("show tk user cmd: %s", cmd)
sshRet, err := sh.RunCMD(cmd)
if err != nil {
  l.Logger.Errorf("curl failed, %v", err)
}
return sshRet
```

ä½†æ˜¯å› ä¸ºè®¿é—® tk ä¸»é¡µæ˜¯ä¸ªç½‘ç»œè¯·æ±‚è¡Œä¸ºï¼Œæ‰€ä»¥ä¸å¾—ä¸è€ƒè™‘è¶…æ—¶é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯å¤„ç†è¶…æ—¶çš„é€»è¾‘ï¼š

```go
sh := NewSSHHelper(sshConf)
// æ¥æ”¶ fetch å‘½ä»¤ç»“æ„çš„ channel
retChan := make(chan string, 1)
// å¼‚æ­¥æ‰§è¡Œï¼Œè®© main è¿›å…¥ select æµç¨‹ 
go func() {
  cmd := fmt.Sprintf("./fetch -t %s", url.PathEscape(tiktokId))
  Logger.Infof("show tk user cmd: %s", cmd)
  sshRet, err := sh.RunCMD(cmd)
  if err != nil {
    l.Logger.Errorf("curl failed, %v", err)
    // å‡ºé”™äº†å†™å…¥ç©ºå€¼ï¼Œåé¢ä¼šåˆ¤æ–­
    retChan <- ""
  }
  retChan <- sshRet
}()

// ç»å…¸çš„ golang è¶…æ—¶æ§åˆ¶ç»“æ„
select {
  case <-time.After(45 * time.Second):
  	return "", status.New(codes.DeadlineExceeded, "è¶…æ—¶").Err()
  case sshRet := <-retChan:
    if sshRet == "" {
      return "", status.New(codes.Unknown, "è§£æå¤±è´¥").Err()
    } else {
      return sshRet, nil
    }
}
```

è‡³æ­¤ï¼Œä¸€ä¸ªç®€æ˜“çš„ tk çˆ¬è™«ä¾¿èƒ½å¤Ÿè·‘èµ·æ¥äº†ã€‚

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfetch ç¨‹åºæ˜¯è¿è¡Œåœ¨èƒ½å¤Ÿè®¿é—® tk çš„æœºå™¨ä¸Šçš„ï¼Œè€Œ fetch ç¨‹åºçš„è°ƒç”¨è€…ï¼Œéœ€è¦é€šè¿‡ ssh è¿æ¥åˆ°è¿™å°æœºå™¨ä¸Šå»è§¦å‘ã€‚å¹¶ä¸”ï¼Œå› ä¸ºæœ‰å¾ˆå¤šåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸéƒ½æœ‰ä¸€ä¸ªä¸»æœºï¼Œæ‰€ä»¥ fetch ç¨‹åºçš„éƒ¨ç½²ä¹Ÿæ˜¯ä¸€ä¸ªç¹ççš„äº‹æƒ…ã€‚

ä¸€å¼€å§‹å†™äº†ä¸€ä¸ª shell è„šæœ¬ï¼Œå¾ªç¯æ‰€æœ‰çš„æœºå™¨åˆ—è¡¨ï¼Œä¸€ä¸ªä¸ªé€šè¿‡ scp æŠŠç¼–è¯‘å¥½çš„ fetch ç¨‹åºéƒ¨ç½²ä¸Šå»ã€‚è™½ç„¶ä¹Ÿèƒ½ç”¨ï¼Œä½†æ˜¯ç”±äºæœºå™¨æ•°é‡å·¨å¤§ï¼Œæœºå™¨åˆ†å¸ƒåœ¨å…¨çƒï¼Œè®¿é—®æ—¶é—´é•¿çŸ­ä¸ä¸€ï¼Œè„šæœ¬åˆä¸èƒ½å¹¶è¡Œï¼Œæ‰€ä»¥å°±æ‰§è¡Œå¾—å¾ˆæ…¢ã€‚

åç»åŒäº‹æŒ‡ç‚¹ï¼Œäº†è§£äº† ansible è¿™ä¸ªå·¥å…·ã€‚é‚£æ˜¯çœŸå¥½ç”¨ã€‚

æ‰€ä»¥ç°åœ¨çš„éƒ¨ç½²è„šæœ¬å°±æ˜¯ï¼š

```shell
# build
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ./fetch ./parseTkState.go
echo 'build done'
sleep 2

# deploy
ansible tk -i ./ansible.ini -m copy -a "src=./fetch dest=~/"
echo 'copy done'

ansible tk -i ./ansible.ini -m file -a "path=/root/fetch mode=0755"
echo 'deploy done'
```

ansible.ini å°±æ˜¯é…ç½®æœºå™¨åˆ—è¡¨ï¼Œå¤§è‡´é•¿è¿™æ ·ï¼š

```ini
[tk]
hostname1 ansible_password=yyy
hostname2
...
[tk:vars]
ansible_connection=ssh
ansible_user=root
ansible_password=xxx
```



## js å®ç°é™æµ

```ts
async function ratelimiter<R>(fns: Array<() => Promise<R>>, cap: number = 10) {
    let cut = []
    let lastIndex = 0
    while ((cut = fns.slice(lastIndex, lastIndex + cap)).length) {
        lastIndex += cut.length
      	// ç­‰è¿™ä¸€æ‰¹è¯·æ±‚å…¨éƒ¨æ‰§è¡Œå®Œå†æ‰§è¡Œä¸‹ä¸€æ‰¹ï¼Œä¹Ÿå¯ä»¥å¢åŠ é—´éš”åœç•™
        await Promise.all(cut.map(c => c()))
        console.log("done batch... ", cut.length);
    }
}

// ä½¿ç”¨
await ratelimiter(tableList.map(row => () => doHardWork(row)), 10)

async function doHardWork(row) {
  // è€—æ—¶çš„è¯·æ±‚
}
```



## go-zero ç›¸å…³ä»£ç å­¦ä¹ 



### syncx åŒ…

ä»£ç ä½ç½®ï¼šgo-zero/core/syncx/singleflight.go





## frp



## Vim

https://coolshell.cn/articles/5426.html

å®éªŒçš„æ—¶å€™æœ€å¥½æ˜¯æ‰¾ä¸€äº›ä»£ç æ¥æ“ä½œ

### å‘½ä»¤æ¨¡å¼ç›¸å…³å‘½ä»¤ï¼š

#### ç¼–è¾‘ç›¸å…³ï¼š

-   x -> åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨çš„ä¸€ä¸ªå­—ç¬¦
-   dd -> åˆ é™¤å½“å‰è¡Œï¼Œå¹¶å­˜å…¥åˆ°å‰ªåˆ‡æ¿ã€‚å°±ç›¸å½“äºå‰ªåˆ‡åŠŸèƒ½ ï¼ˆdd ä¸­é—´å¯åŠ æ•°å­—ï¼Œè¡¨ç¤ºè¦å‰ªåˆ‡çš„è¡Œæ•°ï¼‰
-   p -> ç²˜è´´å‰ªåˆ‡æ¿çš„å†…å®¹åˆ°å½“å‰è¡Œ
-   y -> å¤åˆ¶å½“å‰è¡Œ
-   gu -> å˜å°å†™ï¼ŒgU å˜å¤§å†™ã€‚å¼€å¯å¤§å°å†™è½¬æ¢é€‰æ‹©ï¼Œåé¢è·Ÿå…‰æ ‡ç§»åŠ¨æ“ä½œæ¥ç¡®å®šé€‰æ‹©å“ªäº›å­—ç¬¦è¿›è¡Œå¤§å°å†™è½¬æ¢ã€‚å¦‚ï¼šgUe -> å°†å½“å‰å…‰æ ‡åˆ°å•è¯ç»“å°¾çš„å­—ç¬¦å˜å¤§å†™
-   Ctrl V -> å—é€‰æ‹©æ¨¡å¼ã€‚
    -   Ctrl V -> è¿›å…¥å—é€‰æ‹©æ¨¡å¼
    -   jhkl, ^$ï¼Œä¸Šä¸‹å·¦å³ ç­‰ç­‰æ–¹å¼è¿›è¡Œé€‰æ‹©
    -   I -> æ’å…¥
    -   ESC é€€å‡ºæ¨¡å¼ï¼Œå¹¶å°†è¾“å…¥çš„å†…å®¹åº”ç”¨åˆ°é€‰æ‹©çš„è¡Œ

##### é…åˆå…‰æ ‡ç§»åŠ¨

-   ye -> ä»å½“å‰å…‰æ ‡å¤åˆ¶åˆ°å½“å‰å•è¯ç»“å°¾ã€‚åŒæ ·çš„ï¼Œw, b,W, B éƒ½å¯ä»¥ç»“åˆæ¥å¤åˆ¶å•è¯ä¸­çš„ä¸€éƒ¨åˆ†

##### é‡å¤

-   . -> é‡å¤ä¸Šæ¬¡çš„å‘½ä»¤
-   N<command> -> é‡å¤æŸä¸ªå‘½ä»¤ N æ¬¡
-   100iabcd [ESC] -> æ’å…¥ `abcd ` 100 æ¬¡

#### æ’å…¥æ¨¡å¼ï¼š

-   a -> åœ¨å…‰æ ‡å¤„æ’å…¥ï¼ˆåœ¨å…‰æ ‡å¤„åˆ‡æ¢åˆ°æ’å…¥æ¨¡å¼ï¼‰
-   A -> åœ¨è¡Œå°¾æ’å…¥
-   o -> åœ¨å½“å‰è¡Œåæ’å…¥
-   O -> åœ¨å½“å‰è¡Œå‰æ’å…¥
-   cw -> æ›¿æ¢ä»å…‰æ ‡åˆ°å•è¯ç»“å°¾çš„æ‰€æœ‰å­—ç¬¦ï¼ˆåˆ é™¤å½“å‰ä½ç½®åˆ°å•è¯ç»“å°¾çš„æ‰€æœ‰å­—ç¬¦ï¼Œå¹¶åˆ‡æ¢åˆ°æ’å…¥æ¨¡å¼ï¼‰

#### å…‰æ ‡ç§»åŠ¨ï¼š

-   0 -> åˆ°è¡Œé¦–ï¼ˆä¸è®ºå¼€å¤´æ˜¯ä¸æ˜¯ blankï¼‰
-   $ -> åˆ°è¡Œå°¾ï¼ˆä¸è®ºå¼€å¤´æ˜¯ä¸æ˜¯ blankï¼‰
-   ^ -> åˆ°è¡Œé¦–ï¼ˆåˆ°ç¬¬ä¸€ä¸ªä¸æ˜¯ blank çš„å­—ç¬¦ï¼‰
-   g_ -> åˆ°è¡Œå°¾ï¼ˆåˆ°ç¬¬æœ€åä¸€ä¸ªä¸æ˜¯ blank çš„å­—ç¬¦ï¼‰
-   G -> åˆ°æ–‡ä»¶å°¾ï¼Œ gg -> åˆ°æ–‡ä»¶å¼€å¤´
-   <N>G -> ç›´æ¥è·³åˆ°ç¬¬Nè¡Œå¼€å¤´ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ `:N` ã€‚gg åˆ°ç¬¬ä¸€è¡Œï¼ŒG åˆ°æœ€åä¸€è¡Œ
-   w -> ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•è¯çš„å¼€å¤´
-   e -> ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•è¯çš„ç»“å°¾
-   b -> ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªå•è¯çš„å¼€å¤´
    -   æ³¨ï¼š`w/e/b` å¯¹åº”çš„ `W/E/B` åŠŸèƒ½ç›¸ä¼¼ï¼Œåªæ˜¯å¤§å†™çš„ä¼šè®¤ä¸ºå•è¯æ˜¯ç”¨ blank åˆ†å‰²çš„ï¼Œå°å†™çš„ä¼šè®¤ä¸ºå•è¯æ˜¯ç”±å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ç»„æˆçš„ï¼ˆå…¶ä»–ç¬¦å·åˆ™è®¤ä¸ºæ˜¯å•è¯çš„åˆ†å‰²ç¬¦ï¼‰
-   f<char> -> åœ¨æœ¬è¡Œå†…ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª char çš„ä½ç½® (find)
-   t<char> -> åœ¨æœ¬è¡Œå†…ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª char ä¹‹å‰çš„ä½ç½®ï¼ˆtillï¼‰
-   % -> åœ¨æ‹¬å·çš„å¼€é—­ç¬¦å·é—´ç§»åŠ¨ï¼Œæ”¯æŒ ( [ {    (éœ€è¦å…ˆæŠŠå…‰æ ‡ç§»åŠ¨åˆ°å…¶ä¸­ä¸€ä¸ªæ‹¬å·ä¸Š)
-   `*/#` -> åŒ¹é…å…‰æ ‡æ‰€åœ¨çš„å•è¯ï¼Œå¹¶ç§»åŠ¨åˆ°ä¸Š/ä¸‹ä¸€ä¸ªåŒ¹é…çš„å•è¯ï¼Œ`*` æ˜¯ä¸‹ä¸€ä¸ªï¼Œ`#`æ˜¯ä¸Šä¸€ä¸ªã€‚ï¼ˆå®é™…ä¸Šæ˜¯ç”¨æœç´¢å®ç°çš„ï¼Œåªä¸è¿‡ä¼šè‡ªåŠ¨åŒ¹é…æŸ¥æ‰¾å…³é”®è¯ï¼ŒæŸ¥æ‰¾ä¸€æ¬¡åï¼Œç”¨ n/N éƒ½å¯ä»¥ç»§ç»­æŸ¥æ‰¾ï¼‰
-   Ctrl O -> å›åˆ°å…‰æ ‡çš„ä¸Šä¸€ä¸ªä½ç½®ï¼Œå¯ä»¥æ— è§†æ–‡ä»¶ã€tab é¡µã€çª—å£
-   Ctrl I -> å›åˆ°å…‰æ ‡çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå¯ä»¥æ— è§†æ–‡ä»¶ã€tab é¡µã€çª—å£

#### Undo/redoï¼š

-   u -> undo
-   Ctrl + r -> redo

#### æ–‡ä»¶æ“ä½œï¼š

-   :e <path/to/file> -> æ‰“å¼€æ–°çš„æ–‡ä»¶
-   :bn / :bp -> ä¸Šä¸‹åˆ‡æ¢æ‰“å¼€çš„å¤šä¸ªæ–‡ä»¶
-   :w -> æ–‡ä»¶ç¼–è¾‘åå­˜ç›˜ï¼Œ è‹¥åå¸¦æ–‡ä»¶è·¯å¾„ï¼Œåˆ™ä¼šä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶å
-   :saveas <path/to/file> -> å¦å­˜ä¸º
-   :x / :q -> é€€å‡º

#### å®å½•åˆ¶

-   qa -> å¼€å¯å½•åˆ¶å® a (å¯ä»¥æ˜¯å…¶ä»–åå­—)ï¼Œ q -> ç»“æŸå½•åˆ¶
-   @a -> å›æ”¾å® a
-   @@ -> å›æ”¾æœ€è¿‘åˆ›å»ºçš„ä¸€ä¸ªå®ï¼Œå‰é¢å¯å åŠ æ•°é‡æ¥é‡å¤æ“ä½œ

ä¾‹å­ï¼š

åœ¨ä¸€ä¸ªåªæœ‰ä¸€è¡Œ 1 çš„æ–‡æœ¬ä¸­è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

1.   qa å¼€å¯å½•åˆ¶
2.   Yp å¤åˆ¶ç²˜è´´ä¸€è¡Œ
3.   Ctrl a å°†å½“å‰è¡Œæ•° + 1
4.   q ç»“æŸå½•åˆ¶
5.   100@a å°†åˆ›å»º 102 è¡ŒæŒ‰é¡ºåºæ’å¥½çš„æ•°å­—

#### å¯è§†åŒ–é€‰æ‹©

å¼€å¯ï¼š

-   v -> å¯è§†åŒ–é€‰æ‹©
-   V -> å¯è§†åŒ–è¡Œé€‰æ‹©
-   Ctrl v -> å¯è§†åŒ–å—é€‰æ‹©

å¯è§†åŒ–é€‰æ‹©çš„æ“ä½œï¼š

-   J -> æŠŠæ‰€é€‰çš„è¡Œ join èµ·æ¥
-   <, > -> è¿›è¡Œå¢å‡ç¼©è¿›
-   = -> è‡ªåŠ¨ç¼©è¿›ï¼ˆç›®å‰è¿˜ä¸æ˜ç¡®ç¼©è¿›çš„è§„åˆ™æ˜¯å•¥ï¼Œç¼©è¿›å‡ºæ¥ä¸å¥½çœ‹ï¼‰

#### æ‰§è¡Œ shell å‘½ä»¤

-   :r!<command> -> å°† command åœ¨ shell ä¸­çš„æ‰§è¡Œç»“æœè¯»å–å¹¶å†™å…¥åˆ°å½“å‰ä½ç½®
-   :pwd -> å±•ç¤ºå½“å‰å·¥ä½œç›®å½•

#### åˆ†å±

-   :split -> å¼€å¯æ¨ªå‘åˆ†å±
-   :vsplit -> å¼€å¯çºµå‘åˆ†å±
-   :sp filename -> ä¸Šä¸‹åˆ†å‰²ï¼Œå¹¶æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶
-   :vsp filename -> å·¦å³åˆ†å‰²ï¼Œå¹¶æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶
-   :q -> å…³é—­å½“å‰åˆ†å±
-   Ctrl w -> çª—å£æ“ä½œ
    -   hjkl -> ä¸Šä¸‹å·¦å³é€‰æ‹©çª—å£(æ–¹å‘é”®ä¹Ÿå¯) (å¯¹åº”å¤§å†™çš„åŠŸèƒ½æ˜¯ç§»åŠ¨çª—å£ï¼Œæ­¤æ—¶ä¸èƒ½ç”¨æ–¹å‘é”®äº†)
    -   _ -> æ¨ªå‘æœ€å¤§åŒ–çª—å£
    -   | -> çºµå‘æœ€å¤§åŒ–çª—å£
    -   = -> æ‰€æœ‰çª—å£å°ºå¯¸ä¸€æ ·
    -   `-` -> æ¨ªå‘å‡å°å°ºå¯¸
    -   `+` -> æ¨ªå‘å¢åŠ å°ºå¯¸
    -   c -> å…³é—­å½“å‰çª—å£, å¦‚æœåªå‰©æœ€åä¸€ä¸ªçª—å£ï¼Œåˆ™å…³é—­å¤±è´¥
    -   q -> å¦‚æœåªå‰©æœ€åä¸€ä¸ªåˆ†å±ï¼Œåˆ™å…³é—­ VIM
    -   s -> ä¸Šä¸‹åˆ†å‰²å½“å‰æ–‡ä»¶
    -   v -> å·¦å³åˆ†å‰²å½“å‰æ–‡ä»¶

ç”¨ vim æ‰“å¼€å¤šä¸ªæ–‡ä»¶å¹¶åˆ†å±å±•ç¤ºï¼š

-   vim -on file1 file2 -> æ°´å¹³åˆ†å±
-   vim -On file1 file2 -> å‚ç›´åˆ†å±

n æ˜¯æ•°é‡ï¼Œå¯ä»¥æŒ‡å®šï¼Œä¹Ÿå¯ä»¥å†™ n æ¥æ›´åŠ æ–‡ä»¶æ•°é‡è‡ªåŠ¨åˆ¤æ–­

å¦‚ï¼švim -On file1 -> æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸åˆ†å±

### æ’å…¥æ¨¡å¼ç›¸å…³å‘½ä»¤ï¼š

-   Ctrl n/ Ctrl p -> è‡ªåŠ¨æç¤ºã€‚è¾“å…¥å•è¯å¼€å¤´ï¼Œä¼šå‡ºç°å€™é€‰
